<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🚗 Covoiturage - Carnet Scout</title>
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <!-- Navigation -->
    <div class="fey-container">
        <nav class="fey-nav">
            <button class="fey-tab" onclick="navigateTo('index')">🏠 Accueil</button>
            <button class="fey-tab" onclick="navigateTo('liste')">📋 Ma Liste</button>
            <button class="fey-tab" onclick="navigateTo('calendrier')">📅 Calendrier</button>
            <button class="fey-tab" onclick="navigateTo('admin')">👑 Admin</button>
            <button class="fey-tab" onclick="navigateTo('registre')">📊 Registre</button>
            <button class="fey-tab active">🚗 Covoiturage</button>
        </nav>

        <h1 class="fey-title">🚗 Covoiturage</h1>
        <p class="fey-subtitle">Organisez le covoiturage pour les sorties</p>

        <!-- Sorties avec covoiturage -->
        <div class="fey-card">
            <div class="fey-card-header">🎯 Sorties avec Covoiturage</div>
            <div class="carpool-trips" id="carpoolTrips">
                <!-- Les sorties covoiturage seront chargées ici -->
            </div>
        </div>

        <!-- Gestion des covoiturages -->
        <div class="fey-card" id="carpoolManagement" style="display: none;">
            <div class="fey-card-header">🚗 Gestion du Covoiturage</div>
            <div class="carpool-info">
                <div class="selected-trip-info" id="selectedTripInfo">
                    <!-- Informations de la sortie sélectionnée -->
                </div>
            </div>
            
            <div class="carpool-drivers">
                <h3>👨‍️ Conducteurs</h3>
                <div class="drivers-list" id="driversList">
                    <!-- Liste des conducteurs -->
                </div>
                <button class="fey-btn" onclick="addDriver()">➕ Ajouter un conducteur</button>
            </div>

            <div class="carpool-passengers">
                <h3>👥 Passagers</h3>
                <div class="passengers-list" id="passengersList">
                    <!-- Liste des passagers -->
                </div>
            </div>

            <div class="carpool-actions">
                <button class="fey-btn" onclick="saveCarpool()">💾 Sauvegarder</button>
                <button class="fey-btn" onclick="exportCarpool()">📤 Exporter</button>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script>
        // Navigation
        function navigateTo(page) {
            if (page === 'index') {
                window.location.href = 'index.html';
            } else {
                window.location.href = page + '.html';
            }
        }

        // Données des conducteurs
        const drivers = [
            { id: 1, name: "Jean Dupont", phone: "06 12 34 56 78", seats: 4, car: "Peugeot 308" },
            { id: 2, name: "Marie Martin", phone: "06 87 65 43 21", seats: 3, car: "Renault Clio" },
            { id: 3, name: "Pierre Durand", phone: "06 11 22 33 44", seats: 5, car: "Citroën C4" }
        ];

        let selectedTripId = null;
        let carpoolData = {};

        // Charger les sorties covoiturage
        function loadCarpoolTrips() {
            const saved = localStorage.getItem('carpool-trips');
            if (saved) {
                return JSON.parse(saved);
            }
            return [];
        }

        // Afficher les sorties covoiturage
        function displayCarpoolTrips() {
            const trips = loadCarpoolTrips();
            const container = document.getElementById('carpoolTrips');
            
            if (trips.length === 0) {
                container.innerHTML = '<div class="fey-note">Aucune sortie covoiturage enregistrée. Activez le covoiturage dans la section Admin.</div>';
                return;
            }

            const html = trips.map(trip => `
                <div class="carpool-trip-item" onclick="selectCarpoolTrip(${trip.id})">
                    <div class="trip-info">
                        <div class="trip-title">${trip.title}</div>
                        <div class="trip-date">📅 ${new Date(trip.date).toLocaleDateString('fr-FR')}</div>
                        <div class="trip-location">📍 ${trip.location}</div>
                        <div class="trip-description">${trip.description}</div>
                    </div>
                    <div class="trip-status">
                        <div class="status-indicator">🚗</div>
                        <div class="status-text">Covoiturage activé</div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // Sélectionner une sortie covoiturage
        function selectCarpoolTrip(tripId) {
            selectedTripId = tripId;
            const trips = loadCarpoolTrips();
            const trip = trips.find(t => t.id === tripId);
            
            if (trip) {
                document.getElementById('selectedTripInfo').innerHTML = `
                    <div class="trip-title">${trip.title}</div>
                    <div class="trip-date">📅 ${new Date(trip.date).toLocaleDateString('fr-FR')}</div>
                    <div class="trip-location">📍 ${trip.location}</div>
                `;
                
                document.getElementById('carpoolManagement').style.display = 'block';
                
                loadCarpoolData();
                displayDrivers();
                displayPassengers();
            }
        }

        // Charger les données de covoiturage
        function loadCarpoolData() {
            const saved = localStorage.getItem(`carpool-${selectedTripId}`);
            if (saved) {
                carpoolData = JSON.parse(saved);
            } else {
                carpoolData = {
                    drivers: [],
                    passengers: []
                };
            }
        }

        // Afficher les conducteurs
        function displayDrivers() {
            const container = document.getElementById('driversList');
            
            if (carpoolData.drivers.length === 0) {
                container.innerHTML = '<div class="fey-note">Aucun conducteur enregistré.</div>';
                return;
            }

            const html = carpoolData.drivers.map(driver => `
                <div class="driver-item">
                    <div class="driver-info">
                        <div class="driver-name">${driver.name}</div>
                        <div class="driver-details">
                            <span>📱 ${driver.phone}</span>
                            <span>🚗 ${driver.car}</span>
                            <span>💺 ${driver.seats} places</span>
                        </div>
                    </div>
                    <div class="driver-actions">
                        <button class="fey-btn-small" onclick="editDriver(${driver.id})">✏️</button>
                        <button class="fey-btn-small danger" onclick="removeDriver(${driver.id})">🗑️</button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // Afficher les passagers
        function displayPassengers() {
            const container = document.getElementById('passengersList');
            
            if (carpoolData.passengers.length === 0) {
                container.innerHTML = '<div class="fey-note">Aucun passager enregistré.</div>';
                return;
            }

            const html = carpoolData.passengers.map(passenger => `
                <div class="passenger-item">
                    <div class="passenger-info">
                        <div class="passenger-name">${passenger.name}</div>
                        <div class="passenger-driver">Avec: ${passenger.driverName || 'Non assigné'}</div>
                    </div>
                    <div class="passenger-actions">
                        <button class="fey-btn-small" onclick="assignPassenger(${passenger.id})">👥 Assigner</button>
                        <button class="fey-btn-small danger" onclick="removePassenger(${passenger.id})">🗑️</button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // Ajouter un conducteur
        function addDriver() {
            const name = prompt('Nom du conducteur :');
            if (!name) return;
            
            const phone = prompt('Téléphone :');
            const car = prompt('Modèle de voiture :');
            const seats = parseInt(prompt('Nombre de places disponibles :')) || 4;
            
            const newDriver = {
                id: Date.now(),
                name,
                phone: phone || '',
                car: car || '',
                seats
            };
            
            carpoolData.drivers.push(newDriver);
            displayDrivers();
        }

        // Éditer un conducteur
        function editDriver(driverId) {
            const driver = carpoolData.drivers.find(d => d.id === driverId);
            if (!driver) return;
            
            const name = prompt('Nom du conducteur :', driver.name);
            if (name === null) return;
            
            const phone = prompt('Téléphone :', driver.phone);
            const car = prompt('Modèle de voiture :', driver.car);
            const seats = parseInt(prompt('Nombre de places disponibles :', driver.seats)) || 4;
            
            driver.name = name;
            driver.phone = phone || '';
            driver.car = car || '';
            driver.seats = seats;
            
            displayDrivers();
        }

        // Supprimer un conducteur
        function removeDriver(driverId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer ce conducteur ?')) {
                carpoolData.drivers = carpoolData.drivers.filter(d => d.id !== driverId);
                displayDrivers();
            }
        }

        // Assigner un passager
        function assignPassenger(passengerId) {
            const passenger = carpoolData.passengers.find(p => p.id === passengerId);
            if (!passenger) return;
            
            const availableDrivers = carpoolData.drivers.filter(d => d.seats > 0);
            if (availableDrivers.length === 0) {
                alert('Aucun conducteur disponible.');
                return;
            }
            
            const driverNames = availableDrivers.map(d => d.name).join('\n');
            const selectedDriver = prompt(`Conducteurs disponibles :\n${driverNames}\n\nNom du conducteur :`);
            
            if (selectedDriver) {
                const driver = availableDrivers.find(d => d.name === selectedDriver);
                if (driver) {
                    passenger.driverName = driver.name;
                    passenger.driverId = driver.id;
                    driver.seats--;
                    displayPassengers();
                    displayDrivers();
                }
            }
        }

        // Supprimer un passager
        function removePassenger(passengerId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer ce passager ?')) {
                carpoolData.passengers = carpoolData.passengers.filter(p => p.id !== passengerId);
                displayPassengers();
            }
        }

        // Sauvegarder le covoiturage
        function saveCarpool() {
            if (!selectedTripId) {
                alert('Veuillez d\'abord sélectionner une sortie.');
                return;
            }
            
            localStorage.setItem(`carpool-${selectedTripId}`, JSON.stringify(carpoolData));
            alert('Covoiturage sauvegardé !');
        }

        // Exporter le covoiturage
        function exportCarpool() {
            if (!selectedTripId) {
                alert('Veuillez d\'abord sélectionner une sortie.');
                return;
            }
            
            const trips = loadCarpoolTrips();
            const trip = trips.find(t => t.id === selectedTripId);
            
            if (!trip) {
                alert('Sortie non trouvée.');
                return;
            }
            
            const csvContent = [
                ['Type', 'Nom', 'Téléphone', 'Voiture', 'Places', 'Conducteur assigné'],
                ...carpoolData.drivers.map(driver => ['Conducteur', driver.name, driver.phone, driver.car, driver.seats, '']),
                ...carpoolData.passengers.map(passenger => ['Passager', passenger.name, '', '', '', passenger.driverName || 'Non assigné'])
            ].map(row => row.join(',')).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `covoiturage-${trip.title}-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Initialisation
        function init() {
            displayCarpoolTrips();
        }

        // Démarrer
        window.addEventListener('load', init);
    </script>

    <style>
        .carpool-trips {
            display: grid;
            gap: 1rem;
        }

        .carpool-trip-item {
            background: white;
            border: 2px solid var(--c-ink-900);
            border-radius: var(--r-sm);
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .carpool-trip-item:hover {
            background: rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }

        .trip-info {
            flex: 1;
        }

        .trip-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--c-ink-900);
            margin-bottom: 0.5rem;
        }

        .trip-date, .trip-location {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .trip-description {
            color: var(--c-ink-900);
            font-size: 0.9rem;
        }

        .trip-status {
            text-align: center;
            padding: 1rem;
        }

        .status-indicator {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .status-text {
            color: #666;
            font-size: 0.9rem;
        }

        .carpool-info {
            margin-bottom: 2rem;
        }

        .selected-trip-info {
            background: #E8F5E8;
            padding: 1rem;
            border-radius: var(--r-sm);
            border: 2px solid #4CAF50;
        }

        .carpool-drivers, .carpool-passengers {
            margin-bottom: 2rem;
        }

        .carpool-drivers h3, .carpool-passengers h3 {
            color: var(--c-ink-900);
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--c-ink-900);
            padding-bottom: 0.5rem;
        }

        .drivers-list, .passengers-list {
            display: grid;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .driver-item, .passenger-item {
            background: white;
            border: 2px solid var(--c-ink-900);
            border-radius: var(--r-sm);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .driver-info, .passenger-info {
            flex: 1;
        }

        .driver-name, .passenger-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--c-ink-900);
            margin-bottom: 0.5rem;
        }

        .driver-details {
            display: flex;
            gap: 1rem;
            color: #666;
            font-size: 0.9rem;
        }

        .passenger-driver {
            color: #666;
            font-size: 0.9rem;
        }

        .driver-actions, .passenger-actions {
            display: flex;
            gap: 0.5rem;
        }

        .fey-btn-small {
            padding: 0.5rem;
            font-size: 0.9rem;
            border-radius: var(--r-sm);
            border: 2px solid var(--c-ink-900);
            background: white;
            color: var(--c-ink-900);
            cursor: pointer;
            transition: all 0.2s;
        }

        .fey-btn-small:hover {
            background: var(--c-ink-900);
            color: white;
        }

        .fey-btn-small.danger {
            border-color: #f44336;
            color: #f44336;
        }

        .fey-btn-small.danger:hover {
            background: #f44336;
            color: white;
        }

        .carpool-actions {
            display: flex;
            gap: 0.5rem;
        }
    </style>
</body>
</html>
