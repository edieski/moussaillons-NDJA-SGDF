<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘‘ Admin - Carnet Scout</title>
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <!-- Navigation -->
    <div class="fey-container">
        <nav class="fey-nav">
            <button class="fey-tab" onclick="navigateTo('index')">ğŸ  Accueil</button>
            <button class="fey-tab" onclick="navigateTo('liste')">ğŸ“‹ Ma Liste</button>
            <button class="fey-tab" onclick="navigateTo('calendrier')">ğŸ“… Calendrier</button>
            <button class="fey-tab active">ğŸ‘‘ Admin</button>
            <button class="fey-tab" onclick="navigateTo('registre')">ğŸ“Š Registre</button>
            <button class="fey-tab" onclick="navigateTo('covoiturage')">ğŸš— Covoiturage</button>
        </nav>

        <h1 class="fey-title">ğŸ‘‘ Administration</h1>
        <p class="fey-subtitle">GÃ©rez les sorties, Ã©quipes et paramÃ¨tres</p>

        <!-- Gestion des Sorties -->
        <div class="fey-card">
            <div class="fey-card-header">ğŸ¯ Gestion des Sorties</div>
            <div class="admin-section">
                <div class="admin-controls">
                    <button class="fey-btn" onclick="showAddTripModal()">â• Nouvelle Sortie</button>
                    <button class="fey-btn" onclick="refreshTrips()">ğŸ”„ Actualiser</button>
                </div>
                <div class="trips-list" id="calendarTripsList">
                    <!-- Les sorties seront chargÃ©es ici -->
                </div>
            </div>
        </div>

        <!-- Gestion WhatsApp et Documents -->
        <div class="fey-card">
            <div class="fey-card-header">ğŸ’¬ WhatsApp & Documents</div>
            <div class="admin-section">
                <div class="admin-controls">
                    <button class="fey-btn" onclick="showWhatsAppModal()">ğŸ“± GÃ©rer WhatsApp</button>
                    <button class="fey-btn" onclick="showDocumentsModal()">ğŸ“ GÃ©rer Documents</button>
                </div>
                <div class="whatsapp-docs-preview" id="whatsappDocsPreview">
                    <!-- AperÃ§u des configurations WhatsApp et documents -->
                </div>
            </div>
        </div>

        <!-- Gestion des Sorties Covoiturage -->
        <div class="fey-card">
            <div class="fey-card-header">ğŸš— Gestion des Sorties Covoiturage</div>
            <div class="admin-section">
                <div class="admin-controls">
                    <button class="fey-btn" onclick="addNewCarpoolTrip()">â• Nouvelle Sortie Covoiturage</button>
                    <button class="fey-btn" onclick="refreshCarpoolTrips()">ğŸ”„ Actualiser</button>
                    <button class="fey-btn" onclick="runSupabaseTest()">ğŸ§ª Tester Supabase</button>
                </div>
                <div class="trips-list" id="carpoolTripsList">
                    <!-- Les sorties covoiturage seront chargÃ©es ici -->
                </div>
            </div>
        </div>

        <!-- Gestion des Ã‰quipes -->
        <div class="fey-card">
            <div class="fey-card-header">ğŸ‘¥ Gestion des Ã‰quipes</div>
            <div class="admin-section">
                <div class="admin-controls">
                    <button class="fey-btn" onclick="showTeamEditor()">âœï¸ Ã‰diter les Ã‰quipes</button>
                    <button class="fey-btn" onclick="resetTeamsToDefault()">ğŸ”„ RÃ©initialiser</button>
                    <button class="fey-btn" onclick="exportTeams()">ğŸ“¤ Exporter</button>
                    <button class="fey-btn" onclick="document.getElementById('importFile').click()">ğŸ“¥ Importer</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importTeams(this.files[0])">
                </div>
                
                <!-- AperÃ§u des Ã©quipes actuelles -->
                <div class="team-preview" id="teamPreview">
                    <!-- Les Ã©quipes seront chargÃ©es ici -->
                </div>
            </div>
        </div>

        <!-- Modal d'Ã©dition des Ã©quipes -->
        <div id="teamEditorModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>âœï¸ Ã‰diteur d'Ã‰quipes</h2>
                    <button class="close-btn" onclick="closeTeamEditor()">âœ•</button>
                </div>
                <div class="modal-body">
                    <div class="tabs">
                        <button class="tab-btn active" onclick="switchTeamTab('vie')">ğŸ•ï¸ Ã‰quipes de Vie</button>
                        <button class="tab-btn" onclick="switchTeamTab('nuit')">ğŸŒ™ Ã‰quipes de Nuit</button>
                    </div>
                    
                    <div id="vieTeamsTab" class="tab-content active">
                        <div class="team-editor-section">
                            <div class="section-header">
                                <h3>ğŸ•ï¸ Ã‰quipes de Vie</h3>
                                <button class="fey-btn-small" onclick="addLifeTeam()">â• Ajouter</button>
                            </div>
                            <div id="vieTeamsEditor" class="teams-editor">
                                <!-- Ã‰diteurs d'Ã©quipes de vie -->
                            </div>
                        </div>
                    </div>
                    
                    <div id="nuitTeamsTab" class="tab-content">
                        <div class="team-editor-section">
                            <div class="section-header">
                                <h3>ğŸŒ™ Ã‰quipes de Nuit</h3>
                                <button class="fey-btn-small" onclick="addNightTeam()">â• Ajouter</button>
                            </div>
                            <div id="nuitTeamsEditor" class="teams-editor">
                                <!-- Ã‰diteurs d'Ã©quipes de nuit -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="fey-btn" onclick="saveTeamChanges()">ğŸ’¾ Sauvegarder</button>
                    <button class="fey-btn" onclick="closeTeamEditor()">âŒ Annuler</button>
                </div>
            </div>
        </div>

        <!-- Modal d'Ã©dition des sorties -->
        <div id="tripEditorModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="tripModalTitle">â• Nouvelle Sortie</h2>
                    <button class="close-btn" onclick="closeTripEditor()">âœ•</button>
                </div>
                <div class="modal-body">
                    <form id="tripForm" class="trip-form">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="tripTitle">ğŸ“ Titre de la sortie :</label>
                                <input type="text" id="tripTitle" name="title" class="fey-input" placeholder="Ex: Sortie en forÃªt" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="tripDate">ğŸ“… Date :</label>
                                <input type="date" id="tripDate" name="date" class="fey-input" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="tripStartTime">ğŸ• Heure de dÃ©but :</label>
                                <input type="time" id="tripStartTime" name="startTime" class="fey-input">
                            </div>
                            
                            <div class="form-group">
                                <label for="tripEndTime">ğŸ•• Heure de fin :</label>
                                <input type="time" id="tripEndTime" name="endTime" class="fey-input">
                            </div>
                            
                            <div class="form-group">
                                <label for="tripLocation">ğŸ“ Lieu :</label>
                                <input type="text" id="tripLocation" name="location" class="fey-input" placeholder="Ex: ForÃªt de CompiÃ¨gne">
                            </div>
                            
                            <div class="form-group">
                                <label for="tripAddress">ğŸ  Adresse complÃ¨te :</label>
                                <textarea id="tripAddress" name="address" class="fey-input" rows="2" placeholder="Adresse complÃ¨te avec code postal"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="tripContactName">ğŸ‘¤ Contact responsable :</label>
                                <input type="text" id="tripContactName" name="contactName" class="fey-input" placeholder="Nom du responsable">
                            </div>
                            
                            <div class="form-group">
                                <label for="tripContactPhone">ğŸ“ TÃ©lÃ©phone :</label>
                                <input type="tel" id="tripContactPhone" name="contactPhone" class="fey-input" placeholder="06 12 34 56 78">
                            </div>
                            
                            <div class="form-group">
                                <label for="tripContactEmail">ğŸ“§ Email :</label>
                                <input type="email" id="tripContactEmail" name="contactEmail" class="fey-input" placeholder="contact@example.com">
                            </div>
                            
                            <div class="form-group full-width">
                                <label for="tripDescription">ğŸ“‹ Description :</label>
                                <textarea id="tripDescription" name="description" class="fey-input" rows="3" placeholder="Description dÃ©taillÃ©e de la sortie"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="tripCarpool">ğŸš— Covoiturage :</label>
                                <label class="checkbox-label">
                                    <input type="checkbox" id="tripCarpool" name="carpool">
                                    <span>Activer le covoiturage pour cette sortie</span>
                                </label>
                            </div>
                            
                            <div class="form-group">
                                <label for="tripWhatsAppGroup">ğŸ’¬ Groupe WhatsApp :</label>
                                <input type="url" id="tripWhatsAppGroup" name="whatsappGroup" class="fey-input" placeholder="Lien du groupe WhatsApp (optionnel)">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="fey-btn" onclick="saveTrip()">ğŸ’¾ Sauvegarder</button>
                    <button class="fey-btn" onclick="closeTripEditor()">âŒ Annuler</button>
                </div>
            </div>
        </div>

        <!-- Modal de gestion WhatsApp -->
        <div id="whatsappModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>ğŸ’¬ Gestion WhatsApp</h2>
                    <button class="close-btn" onclick="closeWhatsAppModal()">âœ•</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="whatsappParentsLink">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Lien groupe WhatsApp Parents :</label>
                        <input type="url" id="whatsappParentsLink" class="fey-input" placeholder="https://chat.whatsapp.com/...">
                    </div>
                    <div class="form-group">
                        <label for="whatsappScoutsLink">ğŸ‘¦ğŸ‘§ Lien groupe WhatsApp Scouts :</label>
                        <input type="url" id="whatsappScoutsLink" class="fey-input" placeholder="https://chat.whatsapp.com/...">
                    </div>
                    <div class="form-group">
                        <label for="whatsappQRImage">ğŸ“± Image QR Code (URL) :</label>
                        <input type="url" id="whatsappQRImage" class="fey-input" placeholder="URL de l'image QR code">
                    </div>
                    <div class="form-group">
                        <label for="whatsappDescription">ğŸ“ Description :</label>
                        <textarea id="whatsappDescription" class="fey-input" rows="2" placeholder="Description du groupe WhatsApp"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="fey-btn" onclick="saveWhatsAppSettings()">ğŸ’¾ Sauvegarder</button>
                    <button class="fey-btn" onclick="closeWhatsAppModal()">âŒ Annuler</button>
                </div>
            </div>
        </div>

        <!-- Modal de gestion Documents -->
        <div id="documentsModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>ğŸ“ Gestion des Documents</h2>
                    <button class="close-btn" onclick="closeDocumentsModal()">âœ•</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="documentsDriveLink">ğŸ“š Lien Google Drive :</label>
                        <input type="url" id="documentsDriveLink" class="fey-input" placeholder="https://drive.google.com/...">
                    </div>
                    <div class="form-group">
                        <label for="documentsDescription">ğŸ“ Description :</label>
                        <textarea id="documentsDescription" class="fey-input" rows="3" placeholder="Description des documents disponibles"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="documentsInstructions">ğŸ“‹ Instructions :</label>
                        <textarea id="documentsInstructions" class="fey-input" rows="3" placeholder="Instructions pour accÃ©der aux documents"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="fey-btn" onclick="saveDocumentsSettings()">ğŸ’¾ Sauvegarder</button>
                    <button class="fey-btn" onclick="closeDocumentsModal()">âŒ Annuler</button>
                </div>
            </div>
        </div>

        <!-- Modal de gestion Calendrier -->
        <div id="calendarModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>ğŸ“… Configuration du Calendrier</h2>
                    <button class="close-btn" onclick="closeCalendarModal()">âœ•</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="calendarEmbedUrl">ğŸ“… URL d'intÃ©gration Google Calendar :</label>
                        <input type="url" id="calendarEmbedUrl" class="fey-input" placeholder="https://calendar.google.com/calendar/embed?src=...">
                        <small style="color: #666; font-size: 0.8rem;">
                            Pour obtenir cette URL : Google Calendar â†’ ParamÃ¨tres â†’ IntÃ©grer le calendrier
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="calendarTitle">ğŸ“ Titre du calendrier :</label>
                        <input type="text" id="calendarTitle" class="fey-input" placeholder="Calendrier des Ã‰vÃ©nements Scouts">
                    </div>
                    <div class="form-group">
                        <label for="calendarDescription">ğŸ“‹ Description :</label>
                        <textarea id="calendarDescription" class="fey-input" rows="2" placeholder="Description du calendrier"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="calendarHeight">ğŸ“ Hauteur du calendrier (px) :</label>
                        <input type="number" id="calendarHeight" class="fey-input" value="400" min="200" max="800">
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="calendarAutoSync">
                            <span>ğŸ”„ Synchronisation automatique avec les sorties</span>
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="fey-btn" onclick="saveCalendarSettings()">ğŸ’¾ Sauvegarder</button>
                    <button class="fey-btn" onclick="closeCalendarModal()">âŒ Annuler</button>
                </div>
            </div>
        </div>

        <!-- Gestion du Calendrier -->
        <div class="fey-card">
            <div class="fey-card-header">ğŸ“… Gestion du Calendrier</div>
            <div class="admin-section">
                <div class="admin-controls">
                    <button class="fey-btn" onclick="showCalendarModal()">âš™ï¸ Configurer le Calendrier</button>
                    <button class="fey-btn" onclick="syncCalendar()">ğŸ”„ Synchroniser</button>
                </div>
                <div class="calendar-preview" id="calendarPreview">
                    <!-- AperÃ§u de la configuration du calendrier -->
                </div>
            </div>
        </div>

        <!-- ParamÃ¨tres -->
        <div class="fey-card">
            <div class="fey-card-header">âš™ï¸ ParamÃ¨tres</div>
            <div class="admin-section">
                <div class="settings-grid">
                    <div class="setting-item">
                        <label class="setting-label">Nom du groupe :</label>
                        <input type="text" id="groupName" class="fey-input" placeholder="Nom du groupe scout">
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">Responsable :</label>
                        <input type="text" id="leaderName" class="fey-input" placeholder="Nom du responsable">
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">TÃ©lÃ©phone :</label>
                        <input type="tel" id="leaderPhone" class="fey-input" placeholder="NumÃ©ro de tÃ©lÃ©phone">
                    </div>
                </div>
                <div class="admin-controls">
                    <button class="fey-btn" onclick="saveSettings()">ğŸ’¾ Sauvegarder</button>
                    <button class="fey-btn" onclick="resetSettings()">ğŸ”„ RÃ©initialiser</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/supabaseClient.js"></script>
    <script src="js/common.js"></script>
    <script src="js/equipes.js"></script>
    <script>
        // Navigation
        function navigateTo(page) {
            if (page === 'index') {
                window.location.href = 'index.html';
            } else {
                window.location.href = page + '.html';
            }
        }

        const supabase = window.carpoolSupabase;
        let carpoolTripsCache = [];

        const ADMIN_LOG_PREFIX = '[Admin][Covoiturage]';

        function adminLog(message, payload) {
            if (typeof payload !== 'undefined') {
                console.log(`${ADMIN_LOG_PREFIX} ${message}`, payload);
            } else {
                console.log(`${ADMIN_LOG_PREFIX} ${message}`);
            }
        }

        function adminNotify(message, type = 'info') {
            if (typeof showNotification === 'function') {
                showNotification(message, type);
            } else if (type === 'error') {
                console.error(`${ADMIN_LOG_PREFIX} ${message}`);
            } else if (type === 'warning') {
                console.warn(`${ADMIN_LOG_PREFIX} ${message}`);
            } else {
                console.log(`${ADMIN_LOG_PREFIX} ${message}`);
            }
        }

        // DonnÃ©es des sorties
        const defaultTrips = [
            {
                id: 1,
                title: "Sortie en forÃªt",
                date: "2024-12-15",
                description: "RandonnÃ©e et observation de la nature",
                location: "ForÃªt de CompiÃ¨gne",
                carpool: false
            },
            {
                id: 2,
                title: "RÃ©union d'Ã©quipe",
                date: "2024-12-20",
                description: "PrÃ©paration du camp d'hiver",
                location: "Local scout",
                carpool: false
            },
            {
                id: 3,
                title: "Camp d'hiver",
                date: "2024-12-28",
                description: "Camp de 3 jours en montagne",
                location: "Alpes",
                carpool: true
            }
        ];

        // Charger les sorties depuis localStorage
        function loadTrips() {
            try {
                const saved = localStorage.getItem('admin-outings');
                if (!saved) {
                    adminLog('Aucune sortie locale enregistrÃ©e, utilisation des valeurs par dÃ©faut.');
                    return defaultTrips;
                }

                const parsed = JSON.parse(saved);
                if (!Array.isArray(parsed)) {
                    adminNotify('Format inattendu dans le stockage local, rÃ©initialisation des sorties.', 'warning');
                    return defaultTrips;
                }

                adminLog('Sorties chargÃ©es depuis le stockage local.', parsed);
                return parsed;
            } catch (error) {
                console.error(`${ADMIN_LOG_PREFIX} Erreur lors du chargement des sorties locales`, error);
                adminNotify('Impossible de charger les sorties locales. Valeurs par dÃ©faut utilisÃ©es.', 'warning');
                return defaultTrips;
            }
        }

        // Sauvegarder les sorties
        function saveTrips(trips) {
            try {
                localStorage.setItem('admin-outings', JSON.stringify(trips));
                adminLog('Sorties sauvegardÃ©es dans le stockage local.', trips);
                return true;
            } catch (error) {
                console.error(`${ADMIN_LOG_PREFIX} Erreur lors de la sauvegarde des sorties`, error);
                adminNotify('Impossible de sauvegarder les sorties en local. VÃ©rifiez le quota ou les permissions du navigateur.', 'error');
                return false;
            }
        }

        // Charger les sorties covoiturage depuis Supabase
        async function loadCarpoolTrips() {
            if (!supabase) {
                adminNotify('Configuration Supabase manquante : impossible de charger les sorties covoiturage.', 'error');
                return [];
            }

            adminLog('Chargement des sorties covoiturage depuis Supabase...');

            try {
                const { data, error } = await supabase
                    .from('carpool_trips')
                    .select('*')
                    .order('date', { ascending: true })
                    .order('created_at', { ascending: true });

                if (error) {
                    throw error;
                }

                carpoolTripsCache = data || [];
                adminLog('Sorties covoiturage chargÃ©es depuis Supabase.', carpoolTripsCache);
                return carpoolTripsCache;
            } catch (error) {
                console.error(`${ADMIN_LOG_PREFIX} Erreur lors du chargement des sorties covoiturage`, error);
                adminNotify('Impossible de rÃ©cupÃ©rer les sorties covoiturage depuis Supabase.', 'error');
                return [];
            }
        }

        // Afficher les sorties
        function displayTrips() {
            const trips = loadTrips();
            const container = document.getElementById('calendarTripsList');
            if (!container) {
                console.error(`${ADMIN_LOG_PREFIX} Conteneur #calendarTripsList introuvable.`);
                return;
            }

            adminLog(`Affichage de ${trips.length} sortie(s) locales.`, trips);
            
            if (trips.length === 0) {
                container.innerHTML = '<div class="fey-note">Aucune sortie enregistrÃ©e.</div>';
                return;
            }

            const html = trips.map(trip => {
                const dateStr = trip.date ? new Date(trip.date).toLocaleDateString('fr-FR') : 'Date non dÃ©finie';
                const timeStr = trip.startTime && trip.endTime ? `${trip.startTime} - ${trip.endTime}` : 
                              trip.startTime ? `Ã€ partir de ${trip.startTime}` : '';
                const contactStr = trip.contactName && trip.contactPhone ? `${trip.contactName} (${trip.contactPhone})` : 
                                 trip.contactName || trip.contactPhone || '';
                
                return `
                    <div class="trip-item">
                        <div class="trip-info">
                            <div class="trip-title">${trip.title}</div>
                            <div class="trip-date">ğŸ“… ${dateStr} ${timeStr ? 'â€¢ ' + timeStr : ''}</div>
                            <div class="trip-location">ğŸ“ ${trip.location || 'Lieu non dÃ©fini'}</div>
                            ${trip.address ? `<div class="trip-address">ğŸ  ${trip.address}</div>` : ''}
                            ${contactStr ? `<div class="trip-contact">ğŸ‘¤ ${contactStr}</div>` : ''}
                            ${trip.description ? `<div class="trip-description">${trip.description}</div>` : ''}
                            ${trip.whatsappGroup ? `<div class="trip-whatsapp">ğŸ’¬ <a href="${trip.whatsappGroup}" target="_blank">Groupe WhatsApp</a></div>` : ''}
                        </div>
                        <div class="trip-actions">
                            <label class="carpool-toggle">
                                <input type="checkbox" ${trip.carpool ? 'checked' : ''} 
                                       onchange="toggleCarpool(event, ${trip.id})">
                                <span>ğŸš— Covoiturage</span>
                            </label>
                            <button class="fey-btn-small" onclick="editTrip(${trip.id})">âœï¸</button>
                            <button class="fey-btn-small danger" onclick="deleteTrip(${trip.id})">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // Afficher les sorties covoiturage
        async function displayCarpoolTrips() {
            const container = document.getElementById('carpoolTripsList');
            if (!container) {
                console.error(`${ADMIN_LOG_PREFIX} Conteneur #carpoolTripsList introuvable.`);
                return;
            }

            container.innerHTML = '<div class="fey-note">Chargement des sorties covoiturage...</div>';

            const trips = await loadCarpoolTrips();
            adminLog(`Affichage de ${trips.length} sortie(s) covoiturage depuis Supabase.`, trips);

            if (!trips.length) {
                container.innerHTML = '<div class="fey-note">Aucune sortie covoiturage enregistrÃ©e.</div>';
                return;
            }

            const html = trips.map(trip => `
                <div class="trip-item">
                    <div class="trip-info">
                        <div class="trip-title">${trip.title}</div>
                        <div class="trip-date">ğŸ“… ${trip.date ? new Date(trip.date).toLocaleDateString('fr-FR') : 'Date Ã  dÃ©finir'}</div>
                        <div class="trip-location">ğŸ“ ${trip.location || 'Lieu Ã  dÃ©finir'}</div>
                        <div class="trip-description">${trip.description || ''}</div>
                    </div>
                    <div class="trip-actions">
                        <button class="fey-btn-small" onclick="editCarpoolTrip(${trip.id})">âœï¸</button>
                        <button class="fey-btn-small danger" onclick="deleteCarpoolTrip(${trip.id})">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // Basculer le covoiturage
        async function toggleCarpool(event, tripId) {
            const checkbox = event?.target;
            const isChecked = checkbox?.checked ?? false;
            const trips = loadTrips();
            const trip = trips.find(t => t.id === tripId);

            if (!trip) {
                adminNotify('Sortie introuvable, impossible de modifier le covoiturage.', 'error');
                if (checkbox) {
                    checkbox.checked = !isChecked;
                }
                return;
            }

            if (!supabase) {
                adminNotify('Configuration Supabase manquante. Activez la configuration avant de modifier le covoiturage.', 'error');
                if (checkbox) {
                    checkbox.checked = !isChecked;
                }
                return;
            }

            adminLog(`${isChecked ? 'Activation' : 'DÃ©sactivation'} du covoiturage pour la sortie`, trip);

            if (isChecked) {
                try {
                    const remoteTrips = carpoolTripsCache.length ? carpoolTripsCache : await loadCarpoolTrips();
                    const existingTrip = remoteTrips.find(t => t.title === trip.title && (t.date || null) === (trip.date || null));

                    let data;

                    if (existingTrip) {
                        const { data: updated, error } = await supabase
                            .from('carpool_trips')
                            .update({
                                title: trip.title,
                                date: trip.date || null,
                                location: trip.location || '',
                                description: trip.description || ''
                            })
                            .eq('id', existingTrip.id)
                            .select()
                            .single();

                        if (error) throw error;
                        data = updated;
                    } else {
                        const { data: inserted, error } = await supabase
                            .from('carpool_trips')
                            .insert({
                                title: trip.title,
                                date: trip.date || null,
                                location: trip.location || '',
                                description: trip.description || ''
                            })
                            .select()
                            .single();

                        if (error) throw error;
                        data = inserted;
                    }

                    trip.carpool = true;
                    trip.carpoolTripId = data.id;
                    if (data) {
                        const existingIndex = carpoolTripsCache.findIndex(t => t.id === data.id);
                        if (existingIndex !== -1) {
                            carpoolTripsCache[existingIndex] = data;
                        } else {
                            carpoolTripsCache.push(data);
                        }
                    }
                    const savedLocally = saveTrips(trips);
                    if (savedLocally) {
                        adminNotify(`Covoiturage activÃ© pour "${trip.title}".`, 'success');
                    } else {
                        adminNotify(`Covoiturage activÃ© pour "${trip.title}", mais la sauvegarde locale a Ã©chouÃ©.`, 'warning');
                    }
                } catch (error) {
                    console.error(`${ADMIN_LOG_PREFIX} Erreur lors de l'activation du covoiturage`, error);
                    const reason = error?.message ? ` (${error.message})` : '';
                    adminNotify(`Impossible dâ€™activer le covoiturage${reason}. Merci de rÃ©essayer.`, 'error');
                    if (checkbox) {
                        checkbox.checked = false;
                    }
                    return;
                }
            } else {
                try {
                    let carpoolTripId = trip.carpoolTripId;

                    if (!carpoolTripId) {
                        const remoteTrips = carpoolTripsCache.length ? carpoolTripsCache : await loadCarpoolTrips();
                        const match = remoteTrips.find(t => t.title === trip.title && t.date === trip.date);
                        carpoolTripId = match ? match.id : null;
                    }

                    if (carpoolTripId) {
                        const { error } = await supabase
                            .from('carpool_trips')
                            .delete()
                            .eq('id', carpoolTripId);

                        if (error) throw error;
                        carpoolTripsCache = carpoolTripsCache.filter(t => t.id !== carpoolTripId);
                    }

                    trip.carpool = false;
                    delete trip.carpoolTripId;
                    const savedLocally = saveTrips(trips);
                    if (savedLocally) {
                        adminNotify(`Covoiturage dÃ©sactivÃ© pour "${trip.title}".`, 'success');
                    } else {
                        adminNotify(`Covoiturage dÃ©sactivÃ© pour "${trip.title}", mais la sauvegarde locale a Ã©chouÃ©.`, 'warning');
                    }
                } catch (error) {
                    console.error(`${ADMIN_LOG_PREFIX} Erreur lors de la dÃ©sactivation du covoiturage`, error);
                    const reason = error?.message ? ` (${error.message})` : '';
                    adminNotify(`Impossible de dÃ©sactiver le covoiturage${reason}. Merci de rÃ©essayer.`, 'error');
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                    return;
                }
            }

            displayTrips();
            await displayCarpoolTrips();
        }

        // Variables globales pour l'Ã©dition
        let editingTripId = null;

        // Afficher le modal d'ajout de sortie
        function showAddTripModal() {
            editingTripId = null;
            document.getElementById('tripModalTitle').textContent = 'â• Nouvelle Sortie';
            document.getElementById('tripForm').reset();
            document.getElementById('tripEditorModal').style.display = 'flex';
        }

        // Fermer le modal d'Ã©dition de sortie
        function closeTripEditor() {
            document.getElementById('tripEditorModal').style.display = 'none';
            editingTripId = null;
        }

        // Ã‰diter une sortie existante
        function editTrip(tripId) {
            const trips = loadTrips();
            const trip = trips.find(t => t.id === tripId);
            if (!trip) return;

            editingTripId = tripId;
            document.getElementById('tripModalTitle').textContent = 'âœï¸ Modifier la Sortie';
            
            // Remplir le formulaire
            document.getElementById('tripTitle').value = trip.title || '';
            document.getElementById('tripDate').value = trip.date || '';
            document.getElementById('tripStartTime').value = trip.startTime || '';
            document.getElementById('tripEndTime').value = trip.endTime || '';
            document.getElementById('tripLocation').value = trip.location || '';
            document.getElementById('tripAddress').value = trip.address || '';
            document.getElementById('tripContactName').value = trip.contactName || '';
            document.getElementById('tripContactPhone').value = trip.contactPhone || '';
            document.getElementById('tripContactEmail').value = trip.contactEmail || '';
            document.getElementById('tripDescription').value = trip.description || '';
            document.getElementById('tripCarpool').checked = trip.carpool || false;
            document.getElementById('tripWhatsAppGroup').value = trip.whatsappGroup || '';
            
            document.getElementById('tripEditorModal').style.display = 'flex';
        }

        // Sauvegarder une sortie
        function saveTrip() {
            const form = document.getElementById('tripForm');
            const formData = new FormData(form);
            
            const tripData = {
                title: formData.get('title'),
                date: formData.get('date'),
                startTime: formData.get('startTime'),
                endTime: formData.get('endTime'),
                location: formData.get('location'),
                address: formData.get('address'),
                contactName: formData.get('contactName'),
                contactPhone: formData.get('contactPhone'),
                contactEmail: formData.get('contactEmail'),
                description: formData.get('description'),
                carpool: formData.get('carpool') === 'on',
                whatsappGroup: formData.get('whatsappGroup')
            };

            if (!tripData.title || !tripData.date) {
                adminNotify('Le titre et la date sont obligatoires.', 'warning');
                return;
            }

            const trips = loadTrips();
            
            adminLog(editingTripId ? 'Mise Ã  jour d\'une sortie locale.' : 'CrÃ©ation d\'une nouvelle sortie locale.', { editingTripId, tripData });

            if (editingTripId) {
                // Modification
                const tripIndex = trips.findIndex(t => t.id === editingTripId);
                if (tripIndex !== -1) {
                    trips[tripIndex] = { ...trips[tripIndex], ...tripData };
                }
            } else {
                // Nouvelle sortie
                const newTrip = {
                    id: Date.now(),
                    ...tripData
                };
                trips.push(newTrip);
            }
            
            const saved = saveTrips(trips);
            if (saved) {
                adminNotify('Sortie sauvegardÃ©e.', 'success');
            } else {
                adminNotify('Sortie enregistrÃ©e mais la sauvegarde locale a Ã©chouÃ©.', 'warning');
            }

            displayTrips();
            closeTripEditor();
        }

        // Supprimer une sortie
        function deleteTrip(tripId) {
            if (confirm('ÃŠtes-vous sÃ»r de vouloir supprimer cette sortie ?')) {
                const trips = loadTrips();
                const filtered = trips.filter(t => t.id !== tripId);
                const saved = saveTrips(filtered);
                adminLog('Suppression d\'une sortie locale.', { tripId });
                if (saved) {
                    adminNotify('Sortie supprimÃ©e.', 'success');
                } else {
                    adminNotify('Sortie supprimÃ©e mais la sauvegarde locale a Ã©chouÃ©.', 'warning');
                }
                displayTrips();
            }
        }

        // Ajouter une nouvelle sortie covoiturage
        async function addNewCarpoolTrip() {
            const titleInput = prompt('Titre de la sortie :');
            const title = titleInput ? titleInput.trim() : '';
            if (!title) {
                adminNotify('Le titre est obligatoire pour crÃ©er une sortie.', 'warning');
                return;
            }

            const dateInput = prompt('Date (YYYY-MM-DD) :');
            const date = dateInput ? dateInput.trim() : '';
            const locationInput = prompt('Lieu :');
            const location = locationInput ? locationInput.trim() : '';
            const descriptionInput = prompt('Description :');
            const description = descriptionInput ? descriptionInput.trim() : '';

            if (!supabase) {
                adminNotify('Configuration Supabase manquante.', 'error');
                return;
            }

            adminLog('CrÃ©ation manuelle d\'une sortie covoiturage.', { title, date, location });

            try {
                const { data, error } = await supabase
                    .from('carpool_trips')
                    .insert({
                        title,
                        date: date || null,
                        location: location || '',
                        description: description || ''
                    })
                    .select()
                    .single();

                if (error) throw error;

                carpoolTripsCache.push(data);
                adminNotify(`Sortie covoiturage "${title}" crÃ©Ã©e.`, 'success');
                await displayCarpoolTrips();
            } catch (error) {
                console.error(`${ADMIN_LOG_PREFIX} Erreur lors de la crÃ©ation d'une sortie covoiturage`, error);
                adminNotify('Impossible de crÃ©er la sortie covoiturage. RÃ©essayez plus tard.', 'error');
            }
        }

        // Actualiser les sorties
        function refreshTrips() {
            adminLog('Actualisation manuelle des sorties locales demandÃ©e par l\'utilisateur.');
            displayTrips();
        }

        // Actualiser les sorties covoiturage
        function refreshCarpoolTrips() {
            adminLog('Actualisation manuelle des sorties covoiturage demandÃ©e par l\'utilisateur.');
            displayCarpoolTrips();
        }

        async function runSupabaseTest() {
            if (!supabase) {
                adminNotify('Configuration Supabase manquante. Impossible d\'exÃ©cuter le test.', 'error');
                return;
            }

            const timestamp = new Date().toISOString();
            const testDate = timestamp.slice(0, 10);
            const testLabel = `Test ${timestamp}`;

            adminNotify('Test Supabase en cours...', 'info');
            adminLog('DÃ©but du test Supabase.', { timestamp });

            const created = {
                trip: null,
                driver: null,
                passenger: null
            };

            try {
                const { data: trip, error: tripError } = await supabase
                    .from('carpool_trips')
                    .insert({
                        title: `ğŸ§ª ${testLabel}`,
                        date: testDate,
                        location: 'Test automatique',
                        description: 'EntrÃ©e de test gÃ©nÃ©rÃ©e depuis la page Admin.'
                    })
                    .select()
                    .single();

                if (tripError) {
                    throw new Error(`Insertion carpool_trips: ${tripError.message || 'erreur inconnue'}`);
                }

                created.trip = trip;

                const { data: driver, error: driverError } = await supabase
                    .from('carpool_drivers')
                    .insert({
                        trip_id: trip.id,
                        name: `Conducteur ${testLabel}`,
                        phone: '',
                        car: 'VÃ©hicule de test',
                        seats_available: 4
                    })
                    .select()
                    .single();

                if (driverError) {
                    throw new Error(`Insertion carpool_drivers: ${driverError.message || 'erreur inconnue'}`);
                }

                created.driver = driver;

                const { data: passenger, error: passengerError } = await supabase
                    .from('carpool_passengers')
                    .insert({
                        trip_id: trip.id,
                        name: `Passager ${testLabel}`
                    })
                    .select()
                    .single();

                if (passengerError) {
                    throw new Error(`Insertion carpool_passengers: ${passengerError.message || 'erreur inconnue'}`);
                }

                created.passenger = passenger;

                const [tripCheck, driverCheck, passengerCheck] = await Promise.all([
                    supabase
                        .from('carpool_trips')
                        .select('*')
                        .eq('id', trip.id)
                        .maybeSingle(),
                    supabase
                        .from('carpool_drivers')
                        .select('*')
                        .eq('id', driver.id)
                        .maybeSingle(),
                    supabase
                        .from('carpool_passengers')
                        .select('*')
                        .eq('id', passenger.id)
                        .maybeSingle()
                ]);

                if (tripCheck.error) {
                    throw new Error(`Lecture carpool_trips: ${tripCheck.error.message || 'erreur inconnue'}`);
                }
                if (!tripCheck.data) {
                    throw new Error('Lecture carpool_trips: aucune ligne trouvÃ©e.');
                }

                if (driverCheck.error) {
                    throw new Error(`Lecture carpool_drivers: ${driverCheck.error.message || 'erreur inconnue'}`);
                }
                if (!driverCheck.data) {
                    throw new Error('Lecture carpool_drivers: aucune ligne trouvÃ©e.');
                }

                if (passengerCheck.error) {
                    throw new Error(`Lecture carpool_passengers: ${passengerCheck.error.message || 'erreur inconnue'}`);
                }
                if (!passengerCheck.data) {
                    throw new Error('Lecture carpool_passengers: aucune ligne trouvÃ©e.');
                }

                adminLog('Test Supabase rÃ©ussi.', {
                    trip: tripCheck.data,
                    driver: driverCheck.data,
                    passenger: passengerCheck.data
                });
                adminNotify('Test Supabase rÃ©ussi ! Les trois tables rÃ©pondent correctement.', 'success');
            } catch (error) {
                console.error(`${ADMIN_LOG_PREFIX} Test Supabase Ã©chouÃ©`, error);
                adminNotify(`Test Supabase Ã©chouÃ© : ${error.message || error}`, 'error');
            } finally {
                try {
                    if (created.passenger?.id) {
                        await supabase
                            .from('carpool_passengers')
                            .delete()
                            .eq('id', created.passenger.id);
                    }
                    if (created.driver?.id) {
                        await supabase
                            .from('carpool_drivers')
                            .delete()
                            .eq('id', created.driver.id);
                    }
                    if (created.trip?.id) {
                        await supabase
                            .from('carpool_trips')
                            .delete()
                            .eq('id', created.trip.id);
                    }
                    adminLog('Nettoyage du test Supabase terminÃ©.', created);
                } catch (cleanupError) {
                    console.error(`${ADMIN_LOG_PREFIX} Nettoyage du test Supabase Ã©chouÃ©`, cleanupError);
                }

                if (created.trip?.id) {
                    await displayCarpoolTrips();
                }
            }
        }

        async function editCarpoolTrip(tripId) {
            let trip = carpoolTripsCache.find(t => t.id === tripId);

            if (!trip) {
                const trips = await loadCarpoolTrips();
                trip = trips.find(t => t.id === tripId);
            }

            if (!trip) {
                adminNotify('Sortie covoiturage introuvable.', 'error');
                return;
            }

            const titleInput = prompt('Titre de la sortie :', trip.title || '');
            if (titleInput === null) return;
            const title = titleInput.trim();
            if (!title) {
                adminNotify('Le titre ne peut pas Ãªtre vide.', 'warning');
                return;
            }

            const dateInput = prompt('Date (YYYY-MM-DD) :', trip.date || '');
            if (dateInput === null) return;
            const date = dateInput.trim();

            const locationInput = prompt('Lieu :', trip.location || '');
            if (locationInput === null) return;
            const location = locationInput.trim();

            const descriptionInput = prompt('Description :', trip.description || '');
            if (descriptionInput === null) return;
            const description = descriptionInput.trim();

            adminLog('Mise Ã  jour d\'une sortie covoiturage.', { tripId, title, date, location });

            try {
                const { error } = await supabase
                    .from('carpool_trips')
                    .update({
                        title,
                        date: date || null,
                        location: location || '',
                        description: description || ''
                    })
                    .eq('id', tripId);

                if (error) throw error;

                trip.title = title;
                trip.date = date || null;
                trip.location = location || '';
                trip.description = description || '';

                adminNotify(`Sortie covoiturage "${title}" mise Ã  jour.`, 'success');
                await displayCarpoolTrips();
            } catch (error) {
                console.error(`${ADMIN_LOG_PREFIX} Erreur lors de la mise Ã  jour de la sortie covoiturage`, error);
                adminNotify('Impossible de modifier la sortie covoiturage. RÃ©essayez plus tard.', 'error');
            }
        }

        async function deleteCarpoolTrip(tripId) {
            if (!confirm('ÃŠtes-vous sÃ»r de vouloir supprimer cette sortie covoiturage ?')) {
                return;
            }

            adminLog('Suppression d\'une sortie covoiturage.', { tripId });

            try {
                const { error } = await supabase
                    .from('carpool_trips')
                    .delete()
                    .eq('id', tripId);

                if (error) throw error;

                carpoolTripsCache = carpoolTripsCache.filter(t => t.id !== tripId);
                adminNotify('Sortie covoiturage supprimÃ©e.', 'success');
                await displayCarpoolTrips();
            } catch (error) {
                console.error(`${ADMIN_LOG_PREFIX} Erreur lors de la suppression de la sortie covoiturage`, error);
                adminNotify('Impossible de supprimer la sortie covoiturage. RÃ©essayez plus tard.', 'error');
            }
        }

        // Charger les paramÃ¨tres
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('admin-settings') || '{}');
            document.getElementById('groupName').value = settings.groupName || '';
            document.getElementById('leaderName').value = settings.leaderName || '';
            document.getElementById('leaderPhone').value = settings.leaderPhone || '';
        }

        // Sauvegarder les paramÃ¨tres
        function saveSettings() {
            const settings = {
                groupName: document.getElementById('groupName').value,
                leaderName: document.getElementById('leaderName').value,
                leaderPhone: document.getElementById('leaderPhone').value
            };
            localStorage.setItem('admin-settings', JSON.stringify(settings));
            alert('ParamÃ¨tres sauvegardÃ©s !');
        }

        // RÃ©initialiser les paramÃ¨tres
        function resetSettings() {
            if (confirm('ÃŠtes-vous sÃ»r de vouloir rÃ©initialiser tous les paramÃ¨tres ?')) {
                localStorage.removeItem('admin-settings');
                loadSettings();
            }
        }

        // === GESTION DES Ã‰QUIPES ===
        
        // Afficher l'aperÃ§u des Ã©quipes
        function displayTeamsPreview() {
            const container = document.getElementById('teamPreview');
            const vieTeams = getLifeTeams();
            const nuitTeams = getNightTeams();
            
            let html = '<div class="teams-preview-grid">';
            
            // Ã‰quipes de vie
            html += '<div class="preview-section">';
            html += '<h4>ğŸ•ï¸ Ã‰quipes de Vie</h4>';
            html += '<div class="preview-teams">';
            Object.values(vieTeams).forEach(team => {
                html += `<div class="preview-team" style="background: ${team.color}; color: white; padding: 0.5rem; border-radius: 8px; margin-bottom: 0.5rem;">
                    <strong>${team.name}</strong><br>
                    <small>${team.members.length} membres: ${team.members.join(', ')}</small>
                </div>`;
            });
            html += '</div></div>';
            
            // Ã‰quipes de nuit
            html += '<div class="preview-section">';
            html += '<h4>ğŸŒ™ Ã‰quipes de Nuit</h4>';
            html += '<div class="preview-teams">';
            Object.values(nuitTeams).forEach(team => {
                html += `<div class="preview-team" style="background: ${team.color}; color: white; padding: 0.5rem; border-radius: 8px; margin-bottom: 0.5rem;">
                    <strong>${team.name}</strong><br>
                    <small>${team.members.length} membres: ${team.members.join(', ')}</small>
                </div>`;
            });
            html += '</div></div>';
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Ouvrir l'Ã©diteur d'Ã©quipes
        function showTeamEditor() {
            document.getElementById('teamEditorModal').style.display = 'flex';
            loadTeamsEditor();
        }
        
        // Fermer l'Ã©diteur d'Ã©quipes
        function closeTeamEditor() {
            document.getElementById('teamEditorModal').style.display = 'none';
        }
        
        // Basculer entre les onglets d'Ã©quipes
        function switchTeamTab(tabType) {
            // DÃ©sactiver tous les onglets
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Activer l'onglet sÃ©lectionnÃ©
            event.target.classList.add('active');
            document.getElementById(tabType + 'TeamsTab').classList.add('active');
        }
        
        // Charger l'Ã©diteur d'Ã©quipes
        function loadTeamsEditor() {
            loadVieTeamsEditor();
            loadNuitTeamsEditor();
        }
        
        // Charger l'Ã©diteur des Ã©quipes de vie
        function loadVieTeamsEditor() {
            const container = document.getElementById('vieTeamsEditor');
            const vieTeams = getLifeTeams();
            
            let html = '';
            Object.entries(vieTeams).forEach(([teamId, team]) => {
                html += createTeamEditor(teamId, team, 'vie');
            });
            container.innerHTML = html;
        }
        
        // Charger l'Ã©diteur des Ã©quipes de nuit
        function loadNuitTeamsEditor() {
            const container = document.getElementById('nuitTeamsEditor');
            const nuitTeams = getNightTeams();
            
            let html = '';
            Object.entries(nuitTeams).forEach(([teamId, team]) => {
                html += createTeamEditor(teamId, team, 'nuit');
            });
            container.innerHTML = html;
        }
        
        // CrÃ©er un Ã©diteur d'Ã©quipe
        function createTeamEditor(teamId, team, type) {
            return `
                <div class="team-editor-item">
                    <div class="team-editor-header">
                        <input type="text" value="${team.name}" onchange="updateTeamName('${teamId}', '${type}', this.value)" class="team-name-input">
                        <input type="color" value="#${team.color.match(/rgb\((\d+), (\d+), (\d+)\)/)?.[1]?.toString(16) || 'ff6b35'}" onchange="updateTeamColor('${teamId}', '${type}', this.value)" class="team-color-input">
                        <button class="fey-btn-small danger" onclick="deleteTeam('${teamId}', '${type}')">ğŸ—‘ï¸</button>
                    </div>
                    <div class="team-members-editor">
                        <label>Membres (un par ligne):</label>
                        <textarea rows="6" onchange="updateTeamMembers('${teamId}', '${type}', this.value)">${team.members.join('\n')}</textarea>
                    </div>
                </div>
            `;
        }
        
        // Mettre Ã  jour le nom d'une Ã©quipe
        function updateTeamName(teamId, type, newName) {
            const teams = loadTeams();
            if (teams[type] && teams[type][teamId]) {
                teams[type][teamId].name = newName;
                saveTeams(teams);
            }
        }
        
        // Mettre Ã  jour la couleur d'une Ã©quipe
        function updateTeamColor(teamId, type, newColor) {
            const teams = loadTeams();
            if (teams[type] && teams[type][teamId]) {
                const rgb = hexToRgb(newColor);
                teams[type][teamId].color = `linear-gradient(135deg, rgb(${rgb.r}, ${rgb.g}, ${rgb.b}), rgb(${Math.max(0, rgb.r-30)}, ${Math.max(0, rgb.g-30)}, ${Math.max(0, rgb.b-30)}))`;
                saveTeams(teams);
            }
        }
        
        // Mettre Ã  jour les membres d'une Ã©quipe
        function updateTeamMembers(teamId, type, membersText) {
            const teams = loadTeams();
            if (teams[type] && teams[type][teamId]) {
                const members = membersText.split('\n').filter(m => m.trim() !== '');
                teams[type][teamId].members = members;
                saveTeams(teams);
            }
        }
        
        // Supprimer une Ã©quipe
        function deleteTeam(teamId, type) {
            if (confirm('ÃŠtes-vous sÃ»r de vouloir supprimer cette Ã©quipe ?')) {
                if (type === 'vie') {
                    deleteLifeTeam(teamId);
                } else {
                    deleteNightTeam(teamId);
                }
                loadTeamsEditor();
                displayTeamsPreview();
            }
        }
        
        // Ajouter une nouvelle Ã©quipe de vie
        function addLifeTeam() {
            const name = prompt('Nom de la nouvelle Ã©quipe de vie :');
            if (name) {
                const teamId = createLifeTeam(name, 'linear-gradient(135deg, #ff6b35, #f7931e)', []);
                loadVieTeamsEditor();
                displayTeamsPreview();
            }
        }
        
        // Ajouter une nouvelle Ã©quipe de nuit
        function addNightTeam() {
            const name = prompt('Nom de la nouvelle Ã©quipe de nuit :');
            if (name) {
                const teamId = createNightTeam(name, 'linear-gradient(135deg, #2d3436, #636e72)', []);
                loadNuitTeamsEditor();
                displayTeamsPreview();
            }
        }
        
        // Sauvegarder les changements d'Ã©quipes
        function saveTeamChanges() {
            alert('Ã‰quipes sauvegardÃ©es !');
            displayTeamsPreview();
            closeTeamEditor();
        }
        
        // Convertir hex en RGB
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }

        // === GESTION WHATSAPP ET DOCUMENTS ===
        
        // Charger les paramÃ¨tres WhatsApp
        function loadWhatsAppSettings() {
            const settings = JSON.parse(localStorage.getItem('whatsapp-settings') || '{}');
            document.getElementById('whatsappParentsLink').value = settings.parentsLink || '';
            document.getElementById('whatsappScoutsLink').value = settings.scoutsLink || '';
            document.getElementById('whatsappQRImage').value = settings.qrImage || '';
            document.getElementById('whatsappDescription').value = settings.description || '';
        }

        // Sauvegarder les paramÃ¨tres WhatsApp
        function saveWhatsAppSettings() {
            const settings = {
                parentsLink: document.getElementById('whatsappParentsLink').value,
                scoutsLink: document.getElementById('whatsappScoutsLink').value,
                qrImage: document.getElementById('whatsappQRImage').value,
                description: document.getElementById('whatsappDescription').value
            };
            localStorage.setItem('whatsapp-settings', JSON.stringify(settings));
            alert('ParamÃ¨tres WhatsApp sauvegardÃ©s !');
            closeWhatsAppModal();
            displayWhatsAppDocsPreview();
        }

        // Charger les paramÃ¨tres Documents
        function loadDocumentsSettings() {
            const settings = JSON.parse(localStorage.getItem('documents-settings') || '{}');
            document.getElementById('documentsDriveLink').value = settings.driveLink || '';
            document.getElementById('documentsDescription').value = settings.description || '';
            document.getElementById('documentsInstructions').value = settings.instructions || '';
        }

        // Sauvegarder les paramÃ¨tres Documents
        function saveDocumentsSettings() {
            const settings = {
                driveLink: document.getElementById('documentsDriveLink').value,
                description: document.getElementById('documentsDescription').value,
                instructions: document.getElementById('documentsInstructions').value
            };
            localStorage.setItem('documents-settings', JSON.stringify(settings));
            alert('ParamÃ¨tres Documents sauvegardÃ©s !');
            closeDocumentsModal();
            displayWhatsAppDocsPreview();
        }

        // Afficher le modal WhatsApp
        function showWhatsAppModal() {
            loadWhatsAppSettings();
            document.getElementById('whatsappModal').style.display = 'flex';
        }

        // Fermer le modal WhatsApp
        function closeWhatsAppModal() {
            document.getElementById('whatsappModal').style.display = 'none';
        }

        // Afficher le modal Documents
        function showDocumentsModal() {
            loadDocumentsSettings();
            document.getElementById('documentsModal').style.display = 'flex';
        }

        // Fermer le modal Documents
        function closeDocumentsModal() {
            document.getElementById('documentsModal').style.display = 'none';
        }

        // Afficher l'aperÃ§u WhatsApp et Documents
        function displayWhatsAppDocsPreview() {
            const container = document.getElementById('whatsappDocsPreview');
            const whatsappSettings = JSON.parse(localStorage.getItem('whatsapp-settings') || '{}');
            const documentsSettings = JSON.parse(localStorage.getItem('documents-settings') || '{}');
            
            let html = '<div class="preview-grid">';
            
            // AperÃ§u WhatsApp
            html += '<div class="preview-section">';
            html += '<h4>ğŸ’¬ WhatsApp</h4>';
            if (whatsappSettings.parentsLink || whatsappSettings.scoutsLink) {
                html += '<div class="preview-item">';
                if (whatsappSettings.parentsLink) {
                    html += `<p><strong>Parents:</strong> <a href="${whatsappSettings.parentsLink}" target="_blank">Lien configurÃ©</a></p>`;
                }
                if (whatsappSettings.scoutsLink) {
                    html += `<p><strong>Scouts:</strong> <a href="${whatsappSettings.scoutsLink}" target="_blank">Lien configurÃ©</a></p>`;
                }
                if (whatsappSettings.description) {
                    html += `<p><strong>Description:</strong> ${whatsappSettings.description}</p>`;
                }
                html += '</div>';
            } else {
                html += '<p class="preview-empty">Aucun paramÃ¨tre WhatsApp configurÃ©</p>';
            }
            html += '</div>';
            
            // AperÃ§u Documents
            html += '<div class="preview-section">';
            html += '<h4>ğŸ“ Documents</h4>';
            if (documentsSettings.driveLink) {
                html += '<div class="preview-item">';
                html += `<p><strong>Drive:</strong> <a href="${documentsSettings.driveLink}" target="_blank">Lien configurÃ©</a></p>`;
                if (documentsSettings.description) {
                    html += `<p><strong>Description:</strong> ${documentsSettings.description}</p>`;
                }
                html += '</div>';
            } else {
                html += '<p class="preview-empty">Aucun paramÃ¨tre de documents configurÃ©</p>';
            }
            html += '</div>';
            
            html += '</div>';
            container.innerHTML = html;
        }

        // === GESTION DU CALENDRIER ===
        
        // Charger les paramÃ¨tres du calendrier
        function loadCalendarSettings() {
            const settings = JSON.parse(localStorage.getItem('calendar-settings') || '{}');
            document.getElementById('calendarEmbedUrl').value = settings.embedUrl || '';
            document.getElementById('calendarTitle').value = settings.title || '';
            document.getElementById('calendarDescription').value = settings.description || '';
            document.getElementById('calendarHeight').value = settings.height || 400;
            document.getElementById('calendarAutoSync').checked = settings.autoSync || false;
        }

        // Sauvegarder les paramÃ¨tres du calendrier
        function saveCalendarSettings() {
            const settings = {
                embedUrl: document.getElementById('calendarEmbedUrl').value,
                title: document.getElementById('calendarTitle').value,
                description: document.getElementById('calendarDescription').value,
                height: parseInt(document.getElementById('calendarHeight').value),
                autoSync: document.getElementById('calendarAutoSync').checked
            };
            localStorage.setItem('calendar-settings', JSON.stringify(settings));
            alert('ParamÃ¨tres du calendrier sauvegardÃ©s !');
            closeCalendarModal();
            displayCalendarPreview();
        }

        // Afficher le modal du calendrier
        function showCalendarModal() {
            loadCalendarSettings();
            document.getElementById('calendarModal').style.display = 'flex';
        }

        // Fermer le modal du calendrier
        function closeCalendarModal() {
            document.getElementById('calendarModal').style.display = 'none';
        }

        // Afficher l'aperÃ§u du calendrier
        function displayCalendarPreview() {
            const container = document.getElementById('calendarPreview');
            const calendarSettings = JSON.parse(localStorage.getItem('calendar-settings') || '{}');
            
            if (calendarSettings.embedUrl) {
                let html = '<div class="preview-item">';
                html += `<p><strong>Titre:</strong> ${calendarSettings.title || 'Calendrier des Ã‰vÃ©nements Scouts'}</p>`;
                if (calendarSettings.description) {
                    html += `<p><strong>Description:</strong> ${calendarSettings.description}</p>`;
                }
                html += `<p><strong>Hauteur:</strong> ${calendarSettings.height || 400}px</p>`;
                html += `<p><strong>Synchronisation auto:</strong> ${calendarSettings.autoSync ? 'ActivÃ©e' : 'DÃ©sactivÃ©e'}</p>`;
                html += `<p><strong>URL:</strong> <a href="${calendarSettings.embedUrl}" target="_blank">Lien configurÃ©</a></p>`;
                html += '</div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<p class="preview-empty">Aucune configuration de calendrier</p>';
            }
        }

        // Synchroniser le calendrier avec les sorties
        function syncCalendar() {
            const trips = loadTrips();
            const calendarSettings = JSON.parse(localStorage.getItem('calendar-settings') || '{}');
            
            if (!calendarSettings.embedUrl) {
                alert('Veuillez d\'abord configurer l\'URL du calendrier !');
                return;
            }

            // Ici on pourrait implÃ©menter une synchronisation avec Google Calendar API
            // Pour l'instant, on affiche juste un message de confirmation
            alert(`Synchronisation effectuÃ©e avec ${trips.length} sorties !`);
        }

        // Initialisation
        async function init() {
            displayTrips();
            await displayCarpoolTrips();
            loadSettings();
            displayTeamsPreview();
            displayWhatsAppDocsPreview();
            displayCalendarPreview();
        }

        // DÃ©marrer
        window.addEventListener('load', () => {
            init().catch(error => {
                console.error('Erreur lors de l\'initialisation de la page admin', error);
            });
        });
    </script>

    <style>
        .admin-section {
            margin: 1rem 0;
        }

        .admin-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .trips-list {
            display: grid;
            gap: 1rem;
        }

        .trip-item {
            background: white;
            border-radius: var(--r-sm);
            padding: 1rem;
            border: 2px solid var(--c-ink-900);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .trip-info {
            flex: 1;
        }

        .trip-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--c-ink-900);
            margin-bottom: 0.5rem;
        }

        .trip-date, .trip-location {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .trip-description {
            color: var(--c-ink-900);
            font-size: 0.9rem;
        }

        .trip-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .carpool-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .carpool-toggle input {
            transform: scale(1.2);
        }

        .fey-btn-small {
            padding: 0.5rem;
            font-size: 0.9rem;
            border-radius: var(--r-sm);
            border: 2px solid var(--c-ink-900);
            background: white;
            color: var(--c-ink-900);
            cursor: pointer;
            transition: all 0.2s;
        }

        .fey-btn-small:hover {
            background: var(--c-ink-900);
            color: white;
        }

        .fey-btn-small.danger {
            border-color: #f44336;
            color: #f44336;
        }

        .fey-btn-small.danger:hover {
            background: #f44336;
            color: white;
        }

        .settings-grid {
            display: grid;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .setting-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .setting-label {
            font-weight: bold;
            color: var(--c-ink-900);
        }

        .fey-input {
            padding: 0.75rem;
            border: 2px solid var(--c-ink-900);
            border-radius: var(--r-sm);
            font-size: 1rem;
        }

        .fey-input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        /* Styles pour les formulaires */
        .trip-form {
            max-width: 100%;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-weight: bold;
            color: var(--c-ink-900);
            font-size: 0.9rem;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-weight: normal !important;
        }

        .checkbox-label input[type="checkbox"] {
            transform: scale(1.2);
        }

        /* Styles pour les aperÃ§us */
        .whatsapp-docs-preview {
            margin-top: 1rem;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .preview-section h4 {
            margin-bottom: 1rem;
            color: var(--c-ink-900);
            border-bottom: 2px solid var(--c-ink-900);
            padding-bottom: 0.5rem;
        }

        .preview-item {
            background: white;
            border: 2px solid var(--c-ink-900);
            border-radius: var(--r-sm);
            padding: 1rem;
            margin-bottom: 0.5rem;
        }

        .preview-item p {
            margin: 0.25rem 0;
            font-size: 0.9rem;
        }

        .preview-item a {
            color: #2196F3;
            text-decoration: none;
        }

        .preview-item a:hover {
            text-decoration: underline;
        }

        .preview-empty {
            color: #666;
            font-style: italic;
            text-align: center;
            padding: 1rem;
            background: #f5f5f5;
            border-radius: var(--r-sm);
            border: 2px dashed #ccc;
        }

        /* Styles pour les informations de sortie Ã©tendues */
        .trip-address, .trip-contact, .trip-whatsapp {
            color: #666;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }

        .trip-whatsapp a {
            color: #25D366;
            text-decoration: none;
        }

        .trip-whatsapp a:hover {
            text-decoration: underline;
        }

        /* Styles pour l'aperÃ§u du calendrier */
        .calendar-preview {
            margin-top: 1rem;
        }

        .calendar-preview .preview-item {
            background: white;
            border: 2px solid var(--c-ink-900);
            border-radius: var(--r-sm);
            padding: 1rem;
        }

        .calendar-preview .preview-item p {
            margin: 0.25rem 0;
            font-size: 0.9rem;
        }

        .calendar-preview .preview-item a {
            color: #2196F3;
            text-decoration: none;
        }

        .calendar-preview .preview-item a:hover {
            text-decoration: underline;
        }

        /* Styles pour la gestion des Ã©quipes */
        .teams-preview-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 1rem;
        }

        .preview-section h4 {
            margin-bottom: 1rem;
            color: var(--c-ink-900);
            border-bottom: 2px solid var(--c-ink-900);
            padding-bottom: 0.5rem;
        }

        .preview-teams {
            display: grid;
            gap: 0.5rem;
        }

        .preview-team {
            padding: 0.75rem;
            border-radius: 8px;
            border: 2px solid var(--c-ink-900);
            box-shadow: 2px 2px 0 var(--c-ink-900);
        }

        /* Modal d'Ã©dition des Ã©quipes */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--parchment);
            border-radius: 24px;
            padding: 2rem;
            max-width: 1200px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 4px solid var(--wood);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--c-ink-900);
            padding-bottom: 1rem;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--c-ink-900);
            font-family: 'Patrick Hand', cursive;
        }

        .close-btn {
            background: #F44336;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: #d32f2f;
            transform: scale(1.1);
        }

        .modal-body {
            margin-bottom: 2rem;
        }

        /* Onglets */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--c-ink-900);
        }

        .tab-btn {
            background: var(--c-wood-200);
            border: 2px solid var(--c-ink-900);
            border-bottom: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--r-md) var(--r-md) 0 0;
            cursor: pointer;
            font-family: 'Patrick Hand', cursive;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: var(--c-orange-500);
            color: white;
        }

        .tab-btn.active {
            background: var(--c-orange-600);
            color: white;
        }

        .tab-content {
            display: none;
            padding: 1rem 0;
        }

        .tab-content.active {
            display: block;
        }

        /* Section d'Ã©dition des Ã©quipes */
        .team-editor-section {
            margin-bottom: 2rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--c-ink-900);
        }

        .section-header h3 {
            margin: 0;
            color: var(--c-ink-900);
            font-family: 'Patrick Hand', cursive;
        }

        .teams-editor {
            display: grid;
            gap: 1.5rem;
        }

        .team-editor-item {
            background: white;
            border: 2px solid var(--c-ink-900);
            border-radius: var(--r-md);
            padding: 1.5rem;
            box-shadow: 4px 4px 0 var(--c-ink-900);
        }

        .team-editor-header {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .team-name-input {
            flex: 1;
            min-width: 200px;
            padding: 0.75rem;
            border: 2px solid var(--c-ink-900);
            border-radius: var(--r-sm);
            font-size: 1rem;
            font-weight: bold;
        }

        .team-color-input {
            width: 60px;
            height: 40px;
            border: 2px solid var(--c-ink-900);
            border-radius: var(--r-sm);
            cursor: pointer;
        }

        .team-members-editor label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: var(--c-ink-900);
        }

        .team-members-editor textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--c-ink-900);
            border-radius: var(--r-sm);
            font-size: 0.9rem;
            font-family: 'Nunito', sans-serif;
            resize: vertical;
        }

        .modal-footer {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            padding-top: 1rem;
            border-top: 2px solid var(--c-ink-900);
        }

        /* AmÃ©liorations UI */
        .admin-section {
            margin: 1.5rem 0;
        }

        .admin-controls {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        .admin-controls .fey-btn {
            min-width: 140px;
            font-size: 0.9rem;
            padding: 0.75rem 1rem;
        }

        .fey-card-header {
            font-size: 1.4rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 3px solid var(--c-ink-900);
        }

        .trip-item {
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .trip-item:hover {
            transform: translateY(-2px);
            box-shadow: 6px 8px 0 var(--c-ink-900);
        }

        .trip-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .trip-actions .fey-btn-small {
            min-width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* AmÃ©lioration des modals */
        .modal-content {
            max-width: 1000px;
            width: 95%;
        }

        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        .form-grid {
            gap: 1.5rem;
        }

        .form-group input, .form-group textarea, .form-group select {
            transition: all 0.2s ease;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .teams-preview-grid {
                grid-template-columns: 1fr;
            }
            
            .preview-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .modal-content {
                width: 98%;
                padding: 1rem;
                max-height: 95vh;
            }
            
            .team-editor-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .team-name-input {
                min-width: auto;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .admin-controls {
                justify-content: center;
            }

            .admin-controls .fey-btn {
                flex: 1;
                min-width: auto;
            }

            .trip-item {
                flex-direction: column;
                align-items: stretch;
            }

            .trip-actions {
                justify-content: center;
                margin-top: 1rem;
                padding-top: 1rem;
                border-top: 2px solid #eee;
            }
        }

        @media (max-width: 480px) {
            .fey-card {
                margin-bottom: 1rem;
                padding: 1rem;
            }

            .fey-card-header {
                font-size: 1.2rem;
            }

            .admin-controls {
                flex-direction: column;
            }

            .trip-actions {
                flex-direction: column;
                gap: 0.5rem;
            }

            .trip-actions .fey-btn-small {
                width: 100%;
                min-width: auto;
            }
        }
    </style>
</body>
</html>
