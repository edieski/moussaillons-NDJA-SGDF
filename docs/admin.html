<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üëë Admin - Carnet Scout</title>
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <!-- Navigation -->
    <div class="fey-container">
        <nav class="fey-nav">
            <button class="fey-tab" onclick="navigateTo('index')">üè† Accueil</button>
            <button class="fey-tab" onclick="navigateTo('liste')">üìã Ma Liste</button>
            <button class="fey-tab" onclick="navigateTo('calendrier')">üìÖ Calendrier</button>
            <button class="fey-tab active">üëë Admin</button>
            <button class="fey-tab" onclick="navigateTo('registre')">üìä Registre</button>
            <button class="fey-tab" onclick="navigateTo('covoiturage')">üöó Covoiturage</button>
        </nav>

        <h1 class="fey-title">üëë Administration</h1>
        <p class="fey-subtitle">G√©rez les sorties, √©quipes et param√®tres</p>

        <!-- Gestion des Sorties Covoiturage -->
        <div class="fey-card">
            <div class="fey-card-header">üöó Gestion des Sorties Covoiturage</div>
            <div class="admin-section">
                <div class="admin-controls">
                    <button class="fey-btn" onclick="addNewCarpoolTrip()">‚ûï Nouvelle Sortie Covoiturage</button>
                    <button class="fey-btn" onclick="refreshCarpoolTrips()">üîÑ Actualiser</button>
                    <button class="fey-btn" onclick="runSupabaseTest()">üß™ Tester Supabase</button>
                </div>
                <div class="trips-list" id="carpoolTripsList">
                    <!-- Les sorties covoiturage seront charg√©es ici -->
                </div>
            </div>
        </div>

        <!-- Gestion des √âquipes -->
        <div class="fey-card">
            <div class="fey-card-header">üë• Gestion des √âquipes</div>
            <div class="admin-section">
                <div class="admin-controls">
                    <button class="fey-btn" onclick="showTeamEditor()">‚úèÔ∏è √âditer les √âquipes</button>
                    <button class="fey-btn" onclick="resetTeamsToDefault()">üîÑ R√©initialiser</button>
                    <button class="fey-btn" onclick="exportTeams()">üì§ Exporter</button>
                    <button class="fey-btn" onclick="document.getElementById('importFile').click()">üì• Importer</button>
                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importTeams(this.files[0])">
                </div>
                
                <!-- Aper√ßu des √©quipes actuelles -->
                <div class="team-preview" id="teamPreview">
                    <!-- Les √©quipes seront charg√©es ici -->
                </div>
            </div>
        </div>

        <!-- Param√®tres -->
        <div class="fey-card">
            <div class="fey-card-header">‚öôÔ∏è Param√®tres</div>
            <div class="admin-section">
                <div class="settings-grid">
                    <div class="setting-item">
                        <label class="setting-label">Nom du groupe :</label>
                        <input type="text" id="groupName" class="fey-input" placeholder="Nom du groupe scout">
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">Responsable :</label>
                        <input type="text" id="leaderName" class="fey-input" placeholder="Nom du responsable">
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">T√©l√©phone :</label>
                        <input type="tel" id="leaderPhone" class="fey-input" placeholder="Num√©ro de t√©l√©phone">
                    </div>
                </div>
                <div class="admin-controls">
                    <button class="fey-btn" onclick="saveSettings()">üíæ Sauvegarder</button>
                    <button class="fey-btn" onclick="resetSettings()">üîÑ R√©initialiser</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/supabaseClient.js"></script>
    <script src="js/carpool-manager.js"></script>
    <script src="js/common.js"></script>
    <script src="js/equipes.js"></script>
    <script>
        // Navigation
        function navigateTo(page) {
            if (page === 'index') {
                window.location.href = 'index.html';
            } else {
                window.location.href = page + '.html';
            }
        }

        // ============================================
        // GESTION DU COVOITURAGE (utilise CarpoolManager)
        // ============================================

        // Afficher les sorties covoiturage
        async function displayCarpoolTrips() {
            const container = document.getElementById('carpoolTripsList');
            if (!container) {
                console.error('[Admin] Conteneur #carpoolTripsList introuvable');
                return;
            }

            container.innerHTML = '<div class="fey-note">Chargement des sorties...</div>';

            const trips = await CarpoolManager.loadTrips();
            
            if (!trips.length) {
                container.innerHTML = '<div class="fey-note">Aucune sortie covoiturage enregistr√©e.</div>';
                return;
            }

            const html = trips.map(trip => `
                <div class="trip-item">
                    <div class="trip-info">
                        <div class="trip-title">${trip.title}</div>
                        <div class="trip-date">üìÖ ${trip.date ? new Date(trip.date).toLocaleDateString('fr-FR') : 'Date √† d√©finir'}</div>
                        <div class="trip-location">üìç ${trip.location || 'Lieu √† d√©finir'}</div>
                        ${trip.description ? `<div class="trip-description">${trip.description}</div>` : ''}
                    </div>
                    <div class="trip-actions">
                        <button class="fey-btn-small" onclick="editCarpoolTrip('${trip.id}')">‚úèÔ∏è</button>
                        <button class="fey-btn-small danger" onclick="deleteCarpoolTrip('${trip.id}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // Ajouter une nouvelle sortie
        async function addNewCarpoolTrip() {
            const title = prompt('Titre de la sortie :');
            if (!title || !title.trim()) {
                CarpoolManager.notify('Le titre est obligatoire', 'warning');
                return;
            }

            const date = prompt('Date (YYYY-MM-DD) :');
            const location = prompt('Lieu :');
            const description = prompt('Description :');

            const trip = await CarpoolManager.createTrip({
                title: title.trim(),
                date: date?.trim() || null,
                location: location?.trim() || '',
                description: description?.trim() || ''
            });

            if (trip) {
                await displayCarpoolTrips();
            }
        }

        // Modifier une sortie
        async function editCarpoolTrip(tripId) {
            const trips = CarpoolManager.getTrips();
            const trip = trips.find(t => CarpoolManager.sameId(t.id, tripId));

            if (!trip) {
                CarpoolManager.notify('Sortie introuvable', 'error');
                return;
            }

            const title = prompt('Titre de la sortie :', trip.title);
            if (title === null) return;
            if (!title.trim()) {
                CarpoolManager.notify('Le titre ne peut pas √™tre vide', 'warning');
                return;
            }

            const date = prompt('Date (YYYY-MM-DD) :', trip.date || '');
            if (date === null) return;

            const location = prompt('Lieu :', trip.location || '');
            if (location === null) return;

            const description = prompt('Description :', trip.description || '');
            if (description === null) return;

            const updated = await CarpoolManager.updateTrip(tripId, {
                title: title.trim(),
                date: date.trim() || null,
                location: location.trim(),
                description: description.trim()
            });

            if (updated) {
                await displayCarpoolTrips();
            }
        }

        // Supprimer une sortie
        async function deleteCarpoolTrip(tripId) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette sortie covoiturage ?')) {
                return;
            }

            const success = await CarpoolManager.deleteTrip(tripId);
            if (success) {
                await displayCarpoolTrips();
            }
        }

        // Actualiser les sorties
        function refreshCarpoolTrips() {
            CarpoolManager.clearCache();
            displayCarpoolTrips();
        }

        // Test Supabase
        async function runSupabaseTest() {
            const supabase = window.carpoolSupabase;
            if (!supabase) {
                CarpoolManager.notify('Client Supabase non disponible', 'error');
                return;
            }

            CarpoolManager.notify('Test Supabase en cours...', 'info');

            const created = {
                trip: null,
                driver: null,
                passenger: null
            };

            try {
                // Cr√©er une sortie de test
                const { data: trip, error: tripError } = await supabase
                    .from('carpool_trips')
                    .insert({
                        title: 'TEST - Sortie de test',
                        date: new Date().toISOString().split('T')[0],
                        location: 'Test Location'
                    })
                    .select()
                    .single();

                if (tripError) throw new Error(`Cr√©ation trip: ${tripError.message}`);
                created.trip = trip;

                // Cr√©er un conducteur de test
                const { data: driver, error: driverError } = await supabase
                    .from('carpool_drivers')
                    .insert({
                        trip_id: trip.id,
                        name: 'Test Driver',
                        phone: '0612345678',
                        seats_available: 4
                    })
                    .select()
                    .single();

                if (driverError) throw new Error(`Cr√©ation driver: ${driverError.message}`);
                created.driver = driver;

                // Cr√©er un passager de test
                const { data: passenger, error: passengerError } = await supabase
                    .from('carpool_passengers')
                    .insert({
                        trip_id: trip.id,
                        driver_id: driver.id,
                        name: 'Test Passenger'
                    })
                    .select()
                    .single();

                if (passengerError) throw new Error(`Cr√©ation passenger: ${passengerError.message}`);
                created.passenger = passenger;

                // V√©rifier la lecture
                const { data: tripCheck, error: tripCheckError } = await supabase
                    .from('carpool_trips')
                    .select('*')
                    .eq('id', trip.id)
                    .single();

                if (tripCheckError || !tripCheck) throw new Error('Lecture trip √©chou√©e');

                const { data: driverCheck, error: driverCheckError } = await supabase
                    .from('carpool_drivers')
                    .select('*')
                    .eq('id', driver.id)
                    .single();

                if (driverCheckError || !driverCheck) throw new Error('Lecture driver √©chou√©e');

                const { data: passengerCheck, error: passengerCheckError } = await supabase
                    .from('carpool_passengers')
                    .select('*')
                    .eq('id', passenger.id)
                    .single();

                if (passengerCheckError || !passengerCheck) throw new Error('Lecture passenger √©chou√©e');

                CarpoolManager.notify('Test Supabase r√©ussi ! Les trois tables r√©pondent correctement.', 'success');
            } catch (error) {
                console.error('[Admin] Test Supabase √©chou√©', error);
                CarpoolManager.notify(`Test Supabase √©chou√© : ${error.message}`, 'error');
            } finally {
                // Nettoyage
                try {
                    if (created.passenger?.id) {
                        await supabase.from('carpool_passengers').delete().eq('id', created.passenger.id);
                    }
                    if (created.driver?.id) {
                        await supabase.from('carpool_drivers').delete().eq('id', created.driver.id);
                    }
                    if (created.trip?.id) {
                        await supabase.from('carpool_trips').delete().eq('id', created.trip.id);
                    }
                    await displayCarpoolTrips();
                } catch (cleanupError) {
                    console.error('[Admin] Nettoyage √©chou√©', cleanupError);
                }
            }
        }

        // ============================================
        // GESTION DES √âQUIPES
        // ============================================

        function displayTeamsPreview() {
            const container = document.getElementById('teamPreview');
            if (!container) return;

            const vieTeams = getLifeTeams();
            const nuitTeams = getNightTeams();
            
            let html = '<div class="teams-preview-grid">';
            
            // √âquipes de vie
            html += '<div class="preview-section">';
            html += '<h4>üèïÔ∏è √âquipes de Vie</h4>';
            html += '<div class="preview-teams">';
            Object.values(vieTeams).forEach(team => {
                html += `<div class="preview-team" style="background: ${team.color}; color: white; padding: 0.5rem; border-radius: 8px; margin-bottom: 0.5rem;">
                    <strong>${team.name}</strong><br>
                    <small>${team.members.length} membres: ${team.members.join(', ')}</small>
                </div>`;
            });
            html += '</div></div>';
            
            // √âquipes de nuit
            html += '<div class="preview-section">';
            html += '<h4>üåô √âquipes de Nuit</h4>';
            html += '<div class="preview-teams">';
            Object.values(nuitTeams).forEach(team => {
                html += `<div class="preview-team" style="background: ${team.color}; color: white; padding: 0.5rem; border-radius: 8px; margin-bottom: 0.5rem;">
                    <strong>${team.name}</strong><br>
                    <small>${team.members.length} membres: ${team.members.join(', ')}</small>
                </div>`;
            });
            html += '</div></div>';
            
            html += '</div>';
            container.innerHTML = html;
        }

        function showTeamEditor() {
            alert('√âditeur d\'√©quipes √† impl√©menter - utilisez js/equipes.js pour la gestion');
        }

        // ============================================
        // PARAM√àTRES
        // ============================================

        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('admin-settings') || '{}');
            document.getElementById('groupName').value = settings.groupName || '';
            document.getElementById('leaderName').value = settings.leaderName || '';
            document.getElementById('leaderPhone').value = settings.leaderPhone || '';
        }

        function saveSettings() {
            const settings = {
                groupName: document.getElementById('groupName').value,
                leaderName: document.getElementById('leaderName').value,
                leaderPhone: document.getElementById('leaderPhone').value
            };
            localStorage.setItem('admin-settings', JSON.stringify(settings));
            alert('Param√®tres sauvegard√©s !');
        }

        function resetSettings() {
            if (confirm('√ätes-vous s√ªr de vouloir r√©initialiser tous les param√®tres ?')) {
                localStorage.removeItem('admin-settings');
                loadSettings();
            }
        }

        // ============================================
        // INITIALISATION
        // ============================================

        async function init() {
            await displayCarpoolTrips();
            loadSettings();
            displayTeamsPreview();
        }

        window.addEventListener('load', () => {
            init().catch(error => {
                console.error('[Admin] Erreur d\'initialisation', error);
            });
        });
    </script>

    <style>
        .admin-section {
            margin: 1rem 0;
        }

        .admin-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .trips-list {
            display: grid;
            gap: 1rem;
        }

        .trip-item {
            background: white;
            border-radius: var(--r-sm);
            padding: 1rem;
            border: 2px solid var(--c-ink-900);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .trip-info {
            flex: 1;
        }

        .trip-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--c-ink-900);
            margin-bottom: 0.5rem;
        }

        .trip-date, .trip-location {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .trip-description {
            color: var(--c-ink-900);
            font-size: 0.9rem;
        }

        .trip-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .fey-btn-small {
            padding: 0.5rem 1rem;
            font-size: 1rem;
            min-width: 50px;
        }

        .fey-btn-small.danger {
            background: #f44336;
        }

        .fey-btn-small.danger:hover {
            background: #d32f2f;
        }

        .settings-grid {
            display: grid;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .setting-item {
            display: flex;
            flex-direction: column;
        }

        .setting-label {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: var(--c-ink-900);
        }

        .fey-input {
            padding: 0.75rem;
            border: 2px solid var(--c-ink-900);
            border-radius: var(--r-sm);
            font-size: 1rem;
        }

        .teams-preview-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .preview-section h4 {
            margin-bottom: 1rem;
            color: var(--c-ink-900);
        }

        .preview-teams {
            display: grid;
            gap: 0.5rem;
        }

        .preview-team {
            border: 2px solid var(--c-ink-900);
            box-shadow: 2px 2px 0 var(--c-ink-900);
        }
    </style>
</body>
</html>