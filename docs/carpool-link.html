<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš— Covoiturage Scout</title>
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <!-- Contenu principal avec menu -->
    <div class="fey-container" style="display: block;">
        <h1 class="fey-title">ğŸŒ² Mon carnet d'aventure ğŸŒ²</h1>
        <p class="fey-subtitle">Prochaine sortie Ã  Jambville Â· Octobre 2025</p>

        <nav class="fey-nav">
            <button class="fey-tab" onclick="window.location.href='index.html'">ğŸ  Accueil</button>
            <button class="fey-tab" onclick="window.location.href='index.html'">ğŸ“‹ Ma Liste</button>
            <button class="fey-tab" onclick="window.location.href='index.html#tente'">â›º La Tente</button>
            <button class="fey-tab" onclick="window.location.href='index.html#infos'">ğŸ“± Infos</button>
            <button class="fey-tab" onclick="window.location.href='index.html#equipes'">ğŸ‘¥ Ã‰quipes</button>
            <button class="fey-tab" onclick="window.location.href='index.html#calendrier'">ğŸ“… Calendrier</button>
            <button class="fey-tab active" onclick="window.location.href='carpool-link.html'">ğŸš— Covoiturage</button>
            <button class="fey-tab" onclick="window.location.href='presence.html'">ğŸ“‹ PrÃ©sence</button>
            <button class="fey-tab" onclick="window.location.href='index.html#chansons'">ğŸµ Chansons</button>
            <button class="fey-tab" onclick="window.location.href='index.html#marin'">âš“ Marin</button>
            <button class="fey-tab" onclick="window.location.href='index.html#loi'">ğŸ“œ Loi Scout</button>
        </nav>
    </div>

    <!-- Conteneur principal -->
    <div id="covoiturage" class="fey-page" style="display: block; padding: 2rem; max-width: 1200px; margin: 0 auto;">

        <div class="fey-card-header" style="text-align: center; margin-bottom: 2rem; font-size: 2rem;">
            ğŸš— Covoiturage Scout
        </div>

        <!-- SÃ©lection de sortie -->
        <div class="fey-card" id="carpoolSelectCard">
            <div class="fey-card-header">ğŸ“… Choisir la Sortie</div>
            <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem;">
                <select id="carpoolOutingSelect" style="flex: 1; padding: 0.75rem; border: 2px solid var(--c-ink-900); border-radius: var(--r-sm); font-size: 1rem;" onchange="updateOutingQueryParam()">
                    <option value="">Choisir une sortie...</option>
                </select>
                <button id="carpoolRefreshButton" class="fey-btn" style="background: #4CAF50; padding: 0.75rem 1.5rem;">
                    ğŸ”„ Actualiser
                </button>
            </div>
        </div>

        <!-- MÃ©tadonnÃ©es de la sortie -->
        <div id="carpoolOutingMeta" style="margin-bottom: 1.5rem;"></div>

        <!-- RÃ©sumÃ© statistiques -->
        <div id="carpoolSummaryCard" class="fey-card" style="display: none; margin-bottom: 1.5rem;">
            <div class="fey-card-header">ğŸ“Š RÃ©sumÃ©</div>
            <div id="carpoolSummaryContent" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;"></div>
        </div>

        <div style="display: flex; justify-content: flex-end; margin-bottom: 1.5rem;">
            <button id="carpoolExportButton" class="fey-btn" type="button" style="background: #1976D2; padding: 0.65rem 1.25rem; min-width: 220px;">
                â¬‡ï¸ Exporter le covoiturage (CSV)
            </button>
        </div>

        <!-- Voitures Aller -->
        <div class="fey-card" style="margin-bottom: 1.5rem;">
            <div class="fey-card-header" style="background: linear-gradient(135deg, #E3F2FD, #BBDEFB); border-left: 4px solid #2196F3;">ğŸš— Voitures Aller</div>
            <div id="carpoolDriversListOutbound"></div>
        </div>

        <!-- Enfants sans voiture - Aller -->
        <div class="fey-card" style="margin-bottom: 1.5rem;">
            <div class="fey-card-header" style="background: linear-gradient(135deg, #FFF3E0, #FFE0B2); border-left: 4px solid #FF9800;">âš ï¸ Enfants sans voiture - Aller</div>
            <div id="carpoolUnassignedOutbound"></div>
        </div>

        <!-- Voitures Retour -->
        <div class="fey-card" style="margin-bottom: 1.5rem;">
            <div class="fey-card-header" style="background: linear-gradient(135deg, #F3E5F5, #E1BEE7); border-left: 4px solid #9C27B0;">ğŸ”„ Voitures Retour</div>
            <div id="carpoolDriversListReturn"></div>
        </div>

        <!-- Enfants sans voiture - Retour -->
        <div class="fey-card" style="margin-bottom: 1.5rem;">
            <div class="fey-card-header" style="background: linear-gradient(135deg, #FFF3E0, #FFE0B2); border-left: 4px solid #FF9800;">âš ï¸ Enfants sans voiture - Retour</div>
            <div id="carpoolUnassignedReturn"></div>
        </div>

        <!-- Formulaire conducteur -->
        <div class="fey-card" style="margin-top: 1.5rem; background: linear-gradient(135deg, #E8F5E8, #C8E6C9); border-left: 4px solid #4CAF50;">
            <div class="fey-card-header">ğŸš— Proposer ma voiture</div>
            <form id="carpoolDriverForm" style="display: flex; flex-direction: column; gap: 1rem;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">ğŸ‘¤ Nom</label>
                        <input type="text" name="driverName" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--c-ink-900); border-radius: var(--r-sm);">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">ğŸ“± TÃ©lÃ©phone</label>
                        <input type="tel" name="driverPhone" style="width: 100%; padding: 0.75rem; border: 2px solid var(--c-ink-900); border-radius: var(--r-sm);">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">ğŸ‘¶ Places enfants</label>
                        <input type="number" name="kidSpots" min="0" max="10" value="4" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--c-ink-900); border-radius: var(--r-sm);">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Places adultes</label>
                        <input type="number" name="adultSpots" min="0" max="10" value="0" style="width: 100%; padding: 0.75rem; border: 2px solid var(--c-ink-900); border-radius: var(--r-sm);">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">ğŸš¦ Trajet</label>
                        <select name="roundTrip" style="width: 100%; padding: 0.75rem; border: 2px solid var(--c-ink-900); border-radius: var(--r-sm);">
                            <option value="aller-retour">Aller & Retour</option>
                            <option value="aller-seulement">Aller seulement</option>
                            <option value="retour-seulement">Retour seulement</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">ğŸ“ Notes (optionnel)</label>
                    <textarea name="driverNotes" rows="2" style="width: 100%; padding: 0.75rem; border: 2px solid var(--c-ink-900); border-radius: var(--r-sm);"></textarea>
                </div>
                <button type="submit" class="fey-btn" style="background: #4CAF50; padding: 0.75rem;">
                    âœ… Proposer ma voiture
                </button>
            </form>
        </div>

        <!-- Formulaire passager -->
        <div class="fey-card" style="margin-top: 1.5rem; background: linear-gradient(135deg, #E3F2FD, #BBDEFB); border-left: 4px solid #2196F3;">
            <div class="fey-card-header" style="display:none">ğŸ‘¶ Inscrire un enfant</div>
            <form id="carpoolPassengerForm" style="display:none; flex-direction: column; gap: 1rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">ğŸ‘¶ Nom de l'enfant</label>
                    <select name="childName" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--c-ink-900); border-radius: var(--r-sm);">
                        <option value="">Choisir un enfant...</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Parent/Tuteur</label>
                        <input type="text" name="guardianName" style="width: 100%; padding: 0.75rem; border: 2px solid var(--c-ink-900); border-radius: var(--r-sm);">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">ğŸ“± TÃ©lÃ©phone</label>
                        <input type="tel" name="guardianPhone" style="width: 100%; padding: 0.75rem; border: 2px solid var(--c-ink-900); border-radius: var(--r-sm);">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">ğŸš— Voiture (optionnel)</label>
                        <select name="driverId" style="width: 100%; padding: 0.75rem; border: 2px solid var(--c-ink-900); border-radius: var(--r-sm);">
                            <option value="">Je n'ai pas encore de conducteur</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">ğŸš¦ Trajet</label>
                        <select name="roundTrip" style="width: 100%; padding: 0.75rem; border: 2px solid var(--c-ink-900); border-radius: var(--r-sm);">
                            <option value="aller-retour">Aller & Retour</option>
                            <option value="aller-seulement">Aller seulement</option>
                            <option value="retour-seulement">Retour seulement</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold;">ğŸ“ Notes (optionnel)</label>
                    <textarea name="passengerNotes" rows="2" style="width: 100%; padding: 0.75rem; border: 2px solid var(--c-ink-900); border-radius: var(--r-sm);"></textarea>
                </div>
                <button type="submit" class="fey-btn" style="background: #2196F3; padding: 0.75rem;">
                    âœ… Inscrire l'enfant
                </button>
            </form>
        </div>

    </div>

    <!-- Scripts Supabase et services -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/supabaseClient.js"></script>
    <script src="js/children-service.js"></script>
    <script src="js/scouts-roster.js"></script>
    <script src="js/outings-service.js?v=20251110"></script>
    <script src="js/registrations-service.js"></script>
    <script src="js/attendance-service.js"></script>
    <script src="js/carpool-manager.js"></script>
    <script src="js/carpool-ui.js?v=20251110"></script>
    <script src="js/carpool-driver-editor.js?v=20251110"></script>
    <script src="js/common.js"></script>

    <!-- Script pour prÃ©-sÃ©lectionner la sortie depuis l'URL et gÃ©rer la mise Ã  jour de l'URL -->
    <script>
        // Met Ã  jour l'URL ?outing=... lorsque l'utilisateur choisit une sortie
        function updateOutingQueryParam() {
            const select = document.getElementById('carpoolOutingSelect');
            if (!select) return;
            const option = select.options[select.selectedIndex];
            const value = select.value ? String(select.value) : '';
            const label = option ? option.textContent : value;
            const slug = option?.dataset?.slug ? String(option.dataset.slug) : '';
            try {
                const url = new URL(window.location.href);
                if (value) {
                    url.searchParams.set('outing', value);
                    if (slug) {
                        url.searchParams.set('outting', slug);
                    } else {
                        url.searchParams.set('outting', label);
                    }
                    url.searchParams.set('outingLabel', label);
                } else {
                    url.searchParams.delete('outing');
                    url.searchParams.delete('outting');
                    url.searchParams.delete('outingLabel');
                }
                window.history.replaceState({}, '', url.toString());
            } catch (e) {}
        }

        // Au chargement, si ?outing= est prÃ©sent, sÃ©lection automatique aprÃ¨s que l'UI ait rempli la liste
        (function initOutingFromURL() {
            try {
                const params = new URLSearchParams(window.location.search);
                const outing = params.get('outing') || params.get('outting') || params.get('outingLabel');
                if (!outing) return;
                const sel = document.getElementById('carpoolOutingSelect');
                if (!sel) return;
                const trySelect = () => {
                    const option = Array.from(sel.options).find(o => o.value === outing || o.textContent === outing);
                    if (option) {
                        sel.value = option.value;
                        sel.dispatchEvent(new Event('change'));
                    } else {
                        setTimeout(trySelect, 200);
                    }
                };
                trySelect();
            } catch (e) {}
        })();
        (function() {
            'use strict';

            // Fonction pour mettre Ã  jour l'URL avec le paramÃ¨tre outing
            // Obsolete: URL handling is centralized elsewhere
            function updateURLWithOuting(_) {}

            // RÃ©cupÃ©rer l'ID de sortie depuis l'URL (supporte 'outing' et la faute 'outting')
            const urlParams = new URLSearchParams(window.location.search);
            const outingId = urlParams.get('outing') || urlParams.get('outting') || urlParams.get('outingLabel');

            // Si pas d'ID fourni, on laisse le sÃ©lecteur visible et l'utilisateur choisira
            if (!outingId) {
                console.log('Aucun ID de sortie fourni, affichage du sÃ©lecteur');

                // Ajouter un listener pour mettre Ã  jour l'URL quand l'utilisateur sÃ©lectionne une sortie
                setTimeout(() => {
                    const selectElement = document.getElementById('carpoolOutingSelect');
                    if (selectElement) {
                        // CrÃ©er un wrapper pour l'Ã©vÃ©nement change original
                        // Laisser carpool-ui.js gÃ©rer la sÃ©lection, l'URL et le rendu
                        selectElement.addEventListener('change', function(_){});
                    }
                }, 1000);
                return;
            } else {
                // Un ID est prÃ©sent dans l'URL: sÃ©lectionner cette sortie quand la liste est prÃªte
                setTimeout(() => {
                    const selectElement = document.getElementById('carpoolOutingSelect');
                    if (!selectElement) return;
                    const trySelectById = () => {
                        const opts = Array.from(selectElement.options);
                        // Essayer correspondance par value (id), sinon par label (titre)
                        const opt = opts.find(o => o.value === outingId) || opts.find(o => (o.textContent || '') === outingId);
                        if (opt) {
                            selectElement.value = opt.value;
                            selectElement.dispatchEvent(new Event('change'));
                            const header = document.querySelector('#covoiturage .fey-card-header');
                            if (header) {
                                header.innerHTML = `ğŸš— Covoiturage - ${opt.textContent}`;
                            }
                        } else {
                            // Attendre que les options soient chargÃ©es
                            setTimeout(trySelectById, 200);
                        }
                    };
                    trySelectById();
                }, 0);
            }

            // Si un ID est fourni, on cache le sÃ©lecteur et on prÃ©-sÃ©lectionne automatiquement
            const selectCard = document.getElementById('carpoolSelectCard');
            if (selectCard) {
                selectCard.style.display = 'none';
            }

            // Attendre que carpool-ui.js soit chargÃ© et ait initialisÃ©
            const checkInterval = setInterval(() => {
                const selectElement = document.getElementById('carpoolOutingSelect');
                if (!selectElement) return;

                // VÃ©rifier si des options ont Ã©tÃ© chargÃ©es (plus que l'option par dÃ©faut)
                if (selectElement.options.length > 1) {
                    clearInterval(checkInterval);

                    // Trouver et sÃ©lectionner la bonne option
                    let found = false;
                    for (let i = 0; i < selectElement.options.length; i++) {
                        if (selectElement.options[i].value === outingId) {
                            selectElement.value = outingId;
                            found = true;
                            // DÃ©clencher l'Ã©vÃ©nement change pour que carpool-ui.js charge les donnÃ©es
                            const event = new Event('change', { bubbles: true });
                            selectElement.dispatchEvent(event);
                            break;
                        }
                    }

                    if (!found) {
                        // Sortie non trouvÃ©e
                        document.body.innerHTML = `
                            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 2rem; text-align: center;">
                                <div style="font-size: 4rem; margin-bottom: 1rem;">âŒ</div>
                                <h1 style="color: var(--c-forest-700); margin-bottom: 1rem;">Sortie introuvable</h1>
                                <p style="color: #666; font-size: 1.1rem;">La sortie demandÃ©e n'existe pas ou a Ã©tÃ© supprimÃ©e.</p>
                                <p style="color: #666; margin-top: 0.5rem;">Veuillez contacter votre chef scout pour obtenir un nouveau lien.</p>
                            </div>
                        `;
                    } else {
                        // Afficher les informations de la sortie dans le titre
                        const selectedOption = selectElement.options[selectElement.selectedIndex];
                        const header = document.querySelector('#covoiturage .fey-card-header');
                        if (header && selectedOption) {
                            header.innerHTML = `ğŸš— Covoiturage - ${selectedOption.textContent}`;
                        }
                    }
                }
            }, 100);

            // Timeout aprÃ¨s 10 secondes si rien ne se charge
            setTimeout(() => {
                clearInterval(checkInterval);
                const selectElement = document.getElementById('carpoolOutingSelect');
                if (!selectElement || selectElement.options.length <= 1) {
                    document.body.innerHTML = `
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; padding: 2rem; text-align: center;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">â±ï¸</div>
                            <h1 style="color: var(--c-forest-700); margin-bottom: 1rem;">Impossible de charger</h1>
                            <p style="color: #666; font-size: 1.1rem;">Les donnÃ©es n'ont pas pu Ãªtre chargÃ©es.</p>
                            <p style="color: #666; margin-top: 0.5rem;">VÃ©rifiez votre connexion internet et rÃ©essayez.</p>
                            <button onclick="location.reload()" style="margin-top: 2rem; padding: 1rem 2rem; background: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer;">ğŸ”„ RÃ©essayer</button>
                        </div>
                    `;
                }
            }, 10000);
        })();
    </script>
</body>
</html>
