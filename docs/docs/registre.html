<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📊 Registre d'Appel - Carnet Scout</title>
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <!-- Navigation -->
    <div class="fey-container">
        <nav class="fey-nav">
            <button class="fey-tab" onclick="navigateTo('index')">🏠 Accueil</button>
            <button class="fey-tab" onclick="navigateTo('liste')">📋 Ma Liste</button>
            <button class="fey-tab" onclick="navigateTo('calendrier')">📅 Calendrier</button>
            <button class="fey-tab" onclick="navigateTo('admin')">👑 Admin</button>
            <button class="fey-tab active">📊 Registre</button>
            <button class="fey-tab" onclick="navigateTo('covoiturage')">🚗 Covoiturage</button>
        </nav>

        <h1 class="fey-title">📊 Registre d'Appel</h1>
        <p class="fey-subtitle">Gérez les présences pour chaque sortie</p>

        <!-- Sélection de la sortie -->
        <div class="fey-card">
            <div class="fey-card-header">🎯 Choisir une Sortie</div>
            <div class="trip-selection">
                <div class="trip-checkboxes" id="tripCheckboxes">
                    <!-- Les sorties seront chargées ici -->
                </div>
                <div class="trip-info" id="selectedTripInfo" style="display: none;">
                    <div class="selected-trip">
                        <div class="trip-title" id="selectedTripTitle"></div>
                        <div class="trip-date" id="selectedTripDate"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Liste de présence -->
        <div class="fey-card" id="attendanceCard" style="display: none;">
            <div class="fey-card-header">👥 Liste de Présence</div>
            <div class="attendance-list" id="attendanceList">
                <!-- La liste des enfants sera chargée ici -->
            </div>
            <div class="attendance-actions">
                <button class="fey-btn" onclick="saveAttendance()">💾 Sauvegarder</button>
                <button class="fey-btn" onclick="exportAttendance()">📤 Exporter</button>
            </div>
        </div>

        <!-- Historique -->
        <div class="fey-card">
            <div class="fey-card-header">📚 Historique des Appels</div>
            <div class="history-controls">
                <button class="fey-btn" onclick="refreshHistory()">🔄 Actualiser</button>
                <button class="fey-btn danger" onclick="clearHistory()">🗑️ Effacer tout</button>
            </div>
            <div class="history-list" id="historyList">
                <!-- L'historique sera chargé ici -->
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script>
        // Navigation
        function navigateTo(page) {
            if (page === 'index') {
                window.location.href = 'index.html';
            } else {
                window.location.href = page + '.html';
            }
        }

        // Liste des enfants scouts
        const scoutChildren = [
            "DESCAMPS Jeanne", "LAURENT BILLET Claire", "PICHEREAU Jules", "POTTER Felix",
            "ROUSSEAU Leopold", "JEANJEAN Madeleine", "LALIGAND Lea", "MILLART Constance",
            "REYNAL DE SAINT MICHEL Alexia", "D'ANDREA Dante", "JANDARD Lev", "ROIG Octave",
            "RUEF Alfred", "MATHIEN Ambre", "FAUGERE Lea", "GENTIL Constance",
            "HUCHEZ Sibylle", "LANASPRE Romane", "NIERAT Zoe", "SERVONNAT Louison",
            "WARGNIER Gabrielle", "POTTER Oscar", "ROIG Jules", "TALPAERT Gabriel"
        ];

        let selectedTripId = null;
        let attendanceData = {};

        // Charger les sorties depuis localStorage
        function loadTrips() {
            const saved = localStorage.getItem('admin-outings');
            if (saved) {
                return JSON.parse(saved);
            }
            return [];
        }

        // Afficher les sorties avec des checkboxes
        function displayTrips() {
            const trips = loadTrips();
            const container = document.getElementById('tripCheckboxes');
            
            if (trips.length === 0) {
                container.innerHTML = '<div class="fey-note">Aucune sortie enregistrée. Créez d\'abord des sorties dans la section Admin.</div>';
                return;
            }

            const html = trips.map(trip => `
                <label class="trip-checkbox-item">
                    <input type="radio" name="trip" value="${trip.id}" onchange="selectTrip(${trip.id})">
                    <span class="trip-checkbox-text">
                        <strong>${trip.title}</strong><br>
                        <small>📅 ${new Date(trip.date).toLocaleDateString('fr-FR')}</small>
                    </span>
                </label>
            `).join('');

            container.innerHTML = html;
        }

        // Sélectionner une sortie
        function selectTrip(tripId) {
            selectedTripId = tripId;
            const trips = loadTrips();
            const trip = trips.find(t => t.id === tripId);
            
            if (trip) {
                document.getElementById('selectedTripTitle').textContent = trip.title;
                document.getElementById('selectedTripDate').textContent = `📅 ${new Date(trip.date).toLocaleDateString('fr-FR')}`;
                document.getElementById('selectedTripInfo').style.display = 'block';
                document.getElementById('attendanceCard').style.display = 'block';
                
                createAttendanceList();
            }
        }

        // Créer la liste de présence
        function createAttendanceList() {
            const container = document.getElementById('attendanceList');
            
            // Charger les données de présence existantes
            const saved = localStorage.getItem(`attendance-${selectedTripId}`);
            if (saved) {
                attendanceData = JSON.parse(saved);
            } else {
                // Initialiser avec tous les enfants présents par défaut
                attendanceData = {};
                scoutChildren.forEach(child => {
                    attendanceData[child] = true;
                });
            }

            const html = scoutChildren.map(child => `
                <div class="attendance-item">
                    <label class="attendance-checkbox">
                        <input type="checkbox" ${attendanceData[child] ? 'checked' : ''} 
                               onchange="updateAttendance('${child}')">
                        <span class="attendance-name">${child}</span>
                    </label>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // Mettre à jour la présence d'un enfant
        function updateAttendance(childName) {
            const checkbox = document.querySelector(`input[onchange*="${childName}"]`);
            attendanceData[childName] = checkbox.checked;
        }

        // Sauvegarder la présence
        function saveAttendance() {
            if (!selectedTripId) {
                alert('Veuillez d\'abord sélectionner une sortie.');
                return;
            }

            const trips = loadTrips();
            const trip = trips.find(t => t.id === selectedTripId);
            
            if (!trip) {
                alert('Sortie non trouvée.');
                return;
            }

            // Sauvegarder les données de présence
            localStorage.setItem(`attendance-${selectedTripId}`, JSON.stringify(attendanceData));

            // Ajouter à l'historique
            const history = JSON.parse(localStorage.getItem('attendance-history') || '[]');
            const historyEntry = {
                id: Date.now(),
                tripId: selectedTripId,
                tripTitle: trip.title,
                tripDate: trip.date,
                date: new Date().toISOString(),
                attendance: { ...attendanceData }
            };
            
            history.unshift(historyEntry);
            localStorage.setItem('attendance-history', JSON.stringify(history));

            alert('Présence sauvegardée !');
            refreshHistory();
        }

        // Exporter les données de présence
        function exportAttendance() {
            if (!selectedTripId) {
                alert('Veuillez d\'abord sélectionner une sortie.');
                return;
            }

            const trips = loadTrips();
            const trip = trips.find(t => t.id === selectedTripId);
            
            if (!trip) {
                alert('Sortie non trouvée.');
                return;
            }

            const csvContent = [
                ['Nom', 'Présent'],
                ...scoutChildren.map(child => [child, attendanceData[child] ? 'Oui' : 'Non'])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `presence-${trip.title}-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Actualiser l'historique
        function refreshHistory() {
            const history = JSON.parse(localStorage.getItem('attendance-history') || '[]');
            const container = document.getElementById('historyList');
            
            if (history.length === 0) {
                container.innerHTML = '<div class="fey-note">Aucun appel enregistré.</div>';
                return;
            }

            const html = history.map(entry => {
                const presentCount = Object.values(entry.attendance).filter(present => present).length;
                const totalCount = Object.keys(entry.attendance).length;
                
                return `
                    <div class="history-item">
                        <div class="history-info">
                            <div class="history-title">${entry.tripTitle}</div>
                            <div class="history-date">📅 ${new Date(entry.tripDate).toLocaleDateString('fr-FR')}</div>
                            <div class="history-stats">👥 ${presentCount}/${totalCount} présents</div>
                        </div>
                        <div class="history-actions">
                            <button class="fey-btn-small" onclick="viewAttendance(${entry.id})">👁️ Voir</button>
                            <button class="fey-btn-small danger" onclick="deleteHistoryEntry(${entry.id})">🗑️</button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // Effacer tout l'historique
        function clearHistory() {
            if (confirm('Êtes-vous sûr de vouloir effacer tout l\'historique ?')) {
                localStorage.removeItem('attendance-history');
                refreshHistory();
            }
        }

        // Supprimer une entrée de l'historique
        function deleteHistoryEntry(entryId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette entrée ?')) {
                const history = JSON.parse(localStorage.getItem('attendance-history') || '[]');
                const filtered = history.filter(entry => entry.id !== entryId);
                localStorage.setItem('attendance-history', JSON.stringify(filtered));
                refreshHistory();
            }
        }

        // Voir les détails d'une présence
        function viewAttendance(entryId) {
            const history = JSON.parse(localStorage.getItem('attendance-history') || '[]');
            const entry = history.find(e => e.id === entryId);
            
            if (entry) {
                const presentList = Object.entries(entry.attendance)
                    .filter(([name, present]) => present)
                    .map(([name]) => name);
                
                const absentList = Object.entries(entry.attendance)
                    .filter(([name, present]) => !present)
                    .map(([name]) => name);
                
                let message = `📊 Détails de l'appel pour "${entry.tripTitle}"\n\n`;
                message += `✅ Présents (${presentList.length}) :\n${presentList.join(', ')}\n\n`;
                message += `❌ Absents (${absentList.length}) :\n${absentList.join(', ')}`;
                
                alert(message);
            }
        }

        // Initialisation
        function init() {
            displayTrips();
            refreshHistory();
        }

        // Démarrer
        window.addEventListener('load', init);
    </script>

    <style>
        .trip-selection {
            margin: 1rem 0;
        }

        .trip-checkboxes {
            display: grid;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .trip-checkbox-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: white;
            border: 2px solid var(--c-ink-900);
            border-radius: var(--r-sm);
            cursor: pointer;
            transition: all 0.2s;
        }

        .trip-checkbox-item:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .trip-checkbox-item input[type="radio"] {
            margin-right: 1rem;
            transform: scale(1.2);
        }

        .trip-checkbox-text {
            flex: 1;
        }

        .trip-checkbox-text strong {
            color: var(--c-ink-900);
            font-size: 1.1rem;
        }

        .trip-checkbox-text small {
            color: #666;
        }

        .selected-trip {
            background: #E8F5E8;
            padding: 1rem;
            border-radius: var(--r-sm);
            border: 2px solid #4CAF50;
        }

        .trip-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--c-ink-900);
        }

        .trip-date {
            color: #666;
            margin-top: 0.25rem;
        }

        .attendance-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .attendance-item {
            background: white;
            border: 2px solid var(--c-ink-900);
            border-radius: var(--r-sm);
            padding: 0.75rem;
        }

        .attendance-checkbox {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .attendance-checkbox input {
            margin-right: 0.75rem;
            transform: scale(1.2);
        }

        .attendance-name {
            font-size: 0.9rem;
            color: var(--c-ink-900);
        }

        .attendance-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .history-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .history-list {
            display: grid;
            gap: 1rem;
        }

        .history-item {
            background: white;
            border: 2px solid var(--c-ink-900);
            border-radius: var(--r-sm);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-info {
            flex: 1;
        }

        .history-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--c-ink-900);
        }

        .history-date, .history-stats {
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .history-actions {
            display: flex;
            gap: 0.5rem;
        }

        .fey-btn-small {
            padding: 0.5rem;
            font-size: 0.9rem;
            border-radius: var(--r-sm);
            border: 2px solid var(--c-ink-900);
            background: white;
            color: var(--c-ink-900);
            cursor: pointer;
            transition: all 0.2s;
        }

        .fey-btn-small:hover {
            background: var(--c-ink-900);
            color: white;
        }

        .fey-btn-small.danger {
            border-color: #f44336;
            color: #f44336;
        }

        .fey-btn-small.danger:hover {
            background: #f44336;
            color: white;
        }
    </style>
</body>
</html>
